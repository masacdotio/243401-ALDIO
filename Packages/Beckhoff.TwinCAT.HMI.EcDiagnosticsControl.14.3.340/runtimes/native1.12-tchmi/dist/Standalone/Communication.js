import{Communication as CommonCommunication}from"../Common/Communication.js";import{NotificationCategory,NotificationLevel}from"../Common/Notifications.js";export class Communication extends CommonCommunication{constructor(host,port,secureConnection,ecDiagnostics){super(ecDiagnostics),this.__host=host,this.__port=port,this.__secureConnection=secureConnection;const protocol=this.__secureConnection?"wss":"ws";this.__endpoint=`${protocol}://${this.__host}:${this.__port}`}__endpoint;__host;__port;__secureConnection;__socket=null;__requestCounter=0;establishConnection(callback){const notificationEl=document.createElement("span");this.__ecDiagnostics.getLocalization().addElement(notificationEl,"Server_Connecting",[this.__endpoint]),this.__ecDiagnostics.notification.setNotification(notificationEl,NotificationLevel.info,NotificationCategory.ws),this.__socket=new WebSocket(this.__endpoint),null!==this.__socket?(this.__socket.onopen=event=>{this.__resubscribe();const notificationEl=document.createElement("span");this.__ecDiagnostics.getLocalization().addElement(notificationEl,"Server_Connected",[this.__endpoint]),this.__ecDiagnostics.notification.setNotification(notificationEl,NotificationLevel.success,NotificationCategory.ws,3e3),callback()},this.__socket.onmessage=event=>{const data=JSON.parse(event.data);if(data.error){const error=data.error;if(TcHmi.Log.error(error),error.reason)return void this.__ecDiagnostics.setNotification(`${error.reason}`,NotificationLevel.error,NotificationCategory.ws);if(error.message)return void this.__ecDiagnostics.setNotification(`Message: ${error.message}`,NotificationLevel.error,NotificationCategory.ws);if(error.code)return void this.__ecDiagnostics.setNotification(`Error code: ${error.code}`,NotificationLevel.error,NotificationCategory.ws)}const commands=data.commands;if(!commands||0===commands.length)return void TcHmi.Log.error("Server respond with no commands.");const msgId=data.id;let cb=null;if("Subscription"===data.requestType){if(this.__unsubscribeInProgress.has(msgId))return;cb=this.__subscriptionCallbacks.get(msgId),cb&&super.processReadValues_subscription(cb,data)}else cb=this.__pollingCallbacks.get(msgId),this.__pollingCallbacks.delete(msgId),cb&&super.processReadValues_polling(cb,data)},this.__socket.onerror=event=>{const notificationEl=document.createElement("span");this.__ecDiagnostics.getLocalization().addElement(notificationEl,"Server_Connection_Error"),this.__ecDiagnostics.notification.setNotification(notificationEl,NotificationLevel.error,NotificationCategory.ws)},this.__socket.onclose=event=>{let timeout=2e3;const localization=this.__ecDiagnostics.getLocalization(),notificationEl=document.createElement("span");if(event.wasClean){const notificationServerShutdown=document.createElement("div");localization.addElement(notificationServerShutdown,"Server_Shutdown",[this.__endpoint]),notificationEl.append(notificationServerShutdown)}else{const notificationServerConnectionLost=document.createElement("div");localization.addElement(notificationEl,"Server_Connection_Lost",[this.__endpoint]),notificationEl.append(notificationServerConnectionLost)}if(event.reason){const notificationErrorReason=document.createElement("div");localization.addElement(notificationErrorReason,"Server_Error_Reason",[event.reason]),notificationEl.append(notificationErrorReason),timeout=1e4}const notificationReconnecting=document.createElement("div");localization.addElement(notificationReconnecting,"Server_Reconnecting",[this.__endpoint]),notificationEl.append(notificationReconnecting),this.__ecDiagnostics.clearAllNotifications(),this.__ecDiagnostics.notification.setNotification(notificationEl,NotificationLevel.error,NotificationCategory.ws),this.__reEstablishConnection(timeout)}):this.__reEstablishConnection()}__reEstablishConnection(timeout=2e3){setTimeout(()=>{this.establishConnection(()=>{this.__ecDiagnostics.init()})},timeout)}__resubscribe(){if(0!==this.__subscriptionCallbacks.size)for(const[id,cb]of this.__subscriptionCallbacks)this.__execSubscribe(id,cb.commands,cb.interval,cb.tickCallback,cb.initCallback)}subscribe(commands,interval,tickCallback,initCallback){Array.isArray(commands)||(commands=[commands]);for(const command of commands)command.commandOptions=["SendErrorMessage","SendWriteValue"];const subscriptionId=++this.__requestCounter;return this.__execSubscribe(subscriptionId,commands,interval,tickCallback,initCallback),subscriptionId}__execSubscribe(subscriptionId,commands,interval,tickCallback,initCallback){if(!this.__socket)return!1;const msg={requestType:"Subscription",id:subscriptionId,intervalTime:interval,commands},subscriptionCb={interval,commands,cmdGroup:commands.length>1,tickCallback,initCallback},msg_str=JSON.stringify(msg);return this.__socket.send(msg_str),this.__subscriptionCallbacks.set(subscriptionId,subscriptionCb),!0}unsubscribe(subscriptionId,callback){if(null==subscriptionId||!this.__socket)return null;super.__unsubscribe(subscriptionId);const msg={requestType:"ReadWrite",id:++this.__requestCounter,commands:[{commandOptions:["SendErrorMessage","SendWriteValue"],symbol:"Unsubscribe",writeValue:subscriptionId}]};callback&&this.__pollingCallbacks.set(this.__requestCounter,{tickCallback:callback});const msg_str=JSON.stringify(msg);return this.__socket.send(msg_str),this.__requestCounter}writeSymbol(symbol,writeValue,callback,cbErrorEl){if(this.__socket){const msg={requestType:"ReadWrite",id:++this.__requestCounter,commands:[{commandOptions:["SendErrorMessage","SendWriteValue"],symbol,writeValue}]};this.__pollingCallbacks.set(this.__requestCounter,{tickCallback:callback,errorEl:cbErrorEl});const msgStr=JSON.stringify(msg);this.__socket.send(msgStr)}cbErrorEl?.button?.setStateToLoading()}}