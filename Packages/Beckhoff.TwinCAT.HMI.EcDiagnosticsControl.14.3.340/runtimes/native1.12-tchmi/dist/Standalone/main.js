import{processTheming,store,visualConfig}from"../Common/Appearance.js";import{ColorRGBA}from"../Common/Color.js";import{EcDiagnostics}from"../Common/main.js";import{Communication}from"./Communication.js";import{Localization}from"./Localization.js";import"./TcHmiMockup.js";import"./Helpers/TcHmiContentTabs/ContentTabs.js";function loadTheme(themePath){return fetch(themePath).then(response=>response.ok?response.json():(TcHmi.Log.error(`Couldn't load Theme '${themePath}'. Response code: ${response.status}`),Promise.reject(new Error))).then(data=>{const themeEntry={},themedResources=data.controlTypeValues["TcHmi.Controls.Beckhoff.TcHmiEcDiagnostics"].themedResources;for(const[resourcePathName,themedResource]of Object.entries(themedResources)){let themeEntryChild=themeEntry;const resourcePath=resourcePathName.split("/"),resourceName=resourcePath.pop();if(!resourceName)break;for(const path of resourcePath)themeEntryChild.hasOwnProperty(path)||(themeEntryChild[path]={}),themeEntryChild=themeEntryChild[path];let parsedThemedResource=themedResource;themedResource.hasOwnProperty("color")&&(parsedThemedResource=ColorRGBA.resolveSolidColorAsRGBA(themedResource)),themeEntryChild[resourceName]=parsedThemedResource}processTheming(themeEntry)})}export async function preInit(){const stylesheets=["Style","Standalone","Notifications","ExtendedInfo"],stylesheetsWebComponents=["CanvasTooltip","ContentTabs","PopUp","ProcessDataView","SlaveListView","OptionalBoolInput","StatusButton"],themeStylesheets=["Style","Notification"];function loadStyle(src){const style=document.createElement("link");style.rel="stylesheet",style.type="text/css",style.href=src,document.head.appendChild(style)}const elementsRoot=document.querySelectorAll("beckhoff-ec-diagnostics"),defaultConfig={tchmiServerHostname:window.location.hostname,tchmiServerPort:window.location.port,tchmiServerSecureConnection:"https:"===window.location.protocol,lang:"en",theme:"Base",logLevel:"ErrorsWarningsInfos",device:"Device1",allowZoomAndPan:!0,toolboxResetView:!0,experimentalMode:!1,initTopologyViewPosX:0,initTopologyViewPosY:0,initTopologyViewZoom:null},priorityConfig={};"https:"===window.location.protocol&&(priorityConfig.tchmiServerSecureConnection=!0);const convertParameterValue=(type,key,value)=>{if(""!==value&&null!=value){if("initTopologyViewZoom"===key){const convertedValue=parseInt(value,10)/100;if(isNaN(convertedValue))return;return convertedValue}switch(type){case"number":const convertedValue=parseInt(value,10);if(isNaN(convertedValue))return;return convertedValue;case"boolean":return"true"===value||"false"!==value&&void 0}return value}},urlConfig={},urlParameters=new URLSearchParams(window.location.search);for(const[parameterKey,defaultEntry]of Object.entries(defaultConfig)){const convertedParameterValue=convertParameterValue(typeof defaultEntry,parameterKey,urlParameters.get(parameterKey));void 0!==convertedParameterValue&&(urlConfig[parameterKey]=convertedParameterValue)}const localizations=new Map,comObjs=new Map;for(const elementRoot of elementsRoot){const htmlConfig={};for(const[parameterKey,defaultEntry]of Object.entries(defaultConfig)){const convertedParameterValue=convertParameterValue(typeof defaultEntry,parameterKey,elementRoot.dataset[parameterKey]);void 0!==convertedParameterValue&&(htmlConfig[parameterKey]=convertedParameterValue)}const config={...defaultConfig,...htmlConfig,...urlConfig,...priorityConfig};TcHmi.Log.logLevel=config.logLevel;const baseDir=document.querySelector('meta[name="ecdiagnostics-basedir"]')?.getAttribute("content");if(!baseDir)return void TcHmi.Log.error('BaseDir is not defined. Please add a meta tag in the HTML head like: \'<meta name="ecdiagnostics-basedir" content="./baseDir/" />\'.');if(store.appearance=structuredClone(visualConfig),!store.appearance)return;for(const stylesheet of stylesheets)loadStyle(`${baseDir}/${stylesheet}.css`);for(const themeStylesheet of themeStylesheets)loadStyle(`${baseDir}/Themes/${config.theme}/${themeStylesheet}.css`);for(const webcomponent of stylesheetsWebComponents)loadStyle(`${baseDir}/WebComponents/${webcomponent}/Style.css`),loadStyle(`${baseDir}/Themes/${config.theme}/${webcomponent}/Style.css`);if(loadStyle(`${baseDir}/Themes/${config.theme}/TcHmiFramework/Style.css`),loadStyle(`${baseDir}/Themes/${config.theme}/TcHmiControls/Style.css`),"file:"===window.location.protocol){const notificationWrapper=document.createElement("div");notificationWrapper.classList.add("notifications-wrapper");const notification=document.createElement("div");return notification.classList.add("notifications-wrapper-category","notifications-wrapper-error"),notification.innerHTML="Direct access from hard disk is not supported. Please serve the files from a webserver (http or https).",notificationWrapper.append(notification),void elementRoot.append(notificationWrapper)}try{let localization=localizations.get(config.lang);localization||(localization=new Localization(baseDir,config.lang),await localization.fetchLanguage(),localizations.set(config.lang,localization)),await loadTheme(`${baseDir}/Themes/${config.theme}/Defaults.theme`);const ecDiagnostics=new EcDiagnostics(elementRoot,localization,baseDir,config);await ecDiagnostics.loadTemplates();const serverUrl=`${config.tchmiServerSecureConnection?"wss":"ws"}://${config.tchmiServerHostname}:${config.tchmiServerPort}`;let comObj=comObjs.get(serverUrl);comObj||(comObj=new Communication(config.tchmiServerHostname,config.tchmiServerPort,config.tchmiServerSecureConnection,ecDiagnostics),comObjs.set(serverUrl,comObj)),ecDiagnostics.comObj=comObj,comObj.establishConnection(()=>{ecDiagnostics.preInit(!0)})}catch(err){err&&TcHmi.Log.error(err);const notificationWrapper=document.createElement("div");notificationWrapper.classList.add("notifications-wrapper");const notification=document.createElement("div");notification.classList.add("notifications-wrapper-category","notifications-wrapper-error"),notification.innerHTML=err+"<br />Please find more information in the console log.",notificationWrapper.append(notification),elementRoot.append(notificationWrapper)}}elementsRoot.length||TcHmi.Log.warn("Did not find ecDiagnostics element. Please add an element in the HTML body like: '<ec-diagnostics class=\"ecDiagnostics\"></ec-diagnostics>'.")}"loading"===document.readyState?window.addEventListener("DOMContentLoaded",()=>{preInit()},{once:!0}):preInit();