import{removeNotConnectedDomElements}from"./Utility.js";export class Localization{constructor(){}__localizedTexts=null;__elements=new Map;destroy(){this.cleanUp()}cleanUp(){removeNotConnectedDomElements(this.__elements)}createLocalizedElement(content,elType="div"){const element=document.createElement(elType);let localizationMatch,lastStringIndex=0;const regExLocalized=/{{(?<key>[a-zA-Z0-9\_\-]*)(?:\$(?<placeholders>[a-zA-Z0-9\s\_\-\$\(\)]*))*(?:\.(?<classes>[a-zA-Z0-9\-\_]*))*(?:\$([a-zA-Z0-9\s\_\-\$\(\)]*))*}}/g;for(;null!==(localizationMatch=regExLocalized.exec(content));){const preStringWrapper=document.createElement("span");preStringWrapper.innerHTML=content.substring(lastStringIndex,localizationMatch.index),element.append(preStringWrapper);const localizationWrapper=document.createElement("span"),localizationKey=localizationMatch.groups?.key;if(!localizationKey){TcHmi.Log.warn(`Invalid localization key ${localizationMatch[0]}`);break}const localizationPlaceholders=localizationMatch.groups?.placeholders?.split("$"),localizationClasses=localizationMatch.groups?.classes?.split(".");if(localizationClasses)for(const className of localizationClasses)localizationWrapper.classList.add(className);this.addElement(localizationWrapper,localizationKey.trim(),localizationPlaceholders),element.append(localizationWrapper),lastStringIndex=localizationMatch.index+localizationMatch[0].length}const postStringWrapper=document.createElement("span");return postStringWrapper.innerHTML=content.substring(lastStringIndex,content.length),element.append(postStringWrapper),element}addElement(el,contentKey,placeholders,attributes){const elementData={contentKey,placeholders,attributes};this.cleanUp(),this.__elements.set(el,elementData),this.__insertLocalizedText(el,contentKey,placeholders,attributes)}__insertLocalizedText(el,contentKey,placeholders,attributes){const placeholderRegEx=new RegExp("{[^}]*}","g");let placeholderMatch;if(contentKey){el.innerHTML="";let localizedText=this.getLocalizedText(contentKey),lastIndex=0;if(localizedText.includes("{")){for(;null!==(placeholderMatch=placeholderRegEx.exec(localizedText));){const placeholderKey=placeholderMatch[0].replace("{","").replace("}","").trim();if(!placeholders||void 0===placeholders[placeholderKey]){TcHmi.Log.warn(`No placeholder value for placeholder key '${placeholderKey}' found.`);continue}let placeholderValue=placeholders[placeholderKey];if(["string","number"].includes(typeof placeholderValue)){localizedText=localizedText.replace(`{${placeholderKey}}`,placeholderValue.toString());continue}const firstStringWrapper=document.createElement("span");firstStringWrapper.innerHTML=localizedText.substring(lastIndex,placeholderMatch.index),el.append(firstStringWrapper),lastIndex=placeholderRegEx.lastIndex,"number"==typeof placeholderValue&&(placeholderValue=placeholderValue.toString()),el.append(placeholderValue)}const lastStringWrapper=document.createElement("span");lastStringWrapper.innerHTML=localizedText.substring(lastIndex),el.append(lastStringWrapper)}else el.innerHTML!==localizedText&&(el.innerHTML=localizedText)}if(attributes)for(const[attribute,value]of attributes.entries()){let localizedText=this.getLocalizedText(value.contentKey);if(localizedText.includes("{"))for(;null!==(placeholderMatch=placeholderRegEx.exec(localizedText));){const placeholderKey=placeholderMatch[0].replace("{","").replace("}","").trim();if(!value.placeholders||void 0===value.placeholders[placeholderKey]){TcHmi.Log.warn(`No placeholder value for placeholder key '${placeholderKey}' found.`);continue}const placeholderValue=value.placeholders[placeholderKey];["string","number"].includes(typeof placeholderValue)?localizedText=localizedText.replace(`{${placeholderKey}}`,placeholderValue.toString()):TcHmi.Log.error(`Type ${typeof placeholderValue} is not allowed for placeholders.`)}el.setAttribute(attribute,localizedText)}}replacePlaceholdersInLocalizedText(){}updateAllElements(){this.cleanUp();for(const[el,elData]of this.__elements)this.__insertLocalizedText(el,elData.contentKey,elData.placeholders,elData.attributes)}addAllLocalizedElements(parent){const localizedElements=parent.querySelectorAll("[data-localized-content-key]");for(const el of localizedElements){const contentKey=el.dataset.localizedContentKey;void 0!==contentKey&&this.addElement(el,contentKey)}}}