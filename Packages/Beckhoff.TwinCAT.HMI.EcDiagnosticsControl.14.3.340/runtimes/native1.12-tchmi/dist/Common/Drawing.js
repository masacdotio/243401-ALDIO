import{Master}from"./Master.js";import{Slave}from"./Slave.js";import{StateMachineStateType}from"./Component.js";import{PortName,PortStates}from"./Port.js";import{LayerName,Layers}from"./Layer.js";import"./WebComponents/CanvasTooltip/CanvasTooltip.js";import{customElementsPrefix}from"./Defines.js";import{TopologyView}from"./Topology.js";import{store}from"./Appearance.js";import{ColorRGBA_Black,ColorRGBA_White}from"./Color.js";export function getGlobalOffset(el){const clientRect=el.getBoundingClientRect();return{left:clientRect.left,top:clientRect.top}}export function getGlobalScroll(el){const scroll={x:0,y:0};for(;el&&(scroll.x-=el.scrollLeft,scroll.y-=el.scrollTop,"fixed"!==el.style.position);)el=el.parentElement;return scroll}export class Drawing extends HTMLElement{constructor(main,master,view,dimension){super(),this.__main=main,this.__master=master,this.__view=view,this.classList.add("drawing-wrapper"),dimension&&(this.style.width=`${dimension.width}px`,this.style.height=`${dimension.height}px`),this.__view===TopologyView.Network&&this.classList.add("network-view"),this.__focusedLayers=new Layers,this.__focusedLayers.init(),this.append(this.__focusedLayers),main.addTopMostLayer(this.__tooltip)}__tooltip=document.createElement(customElementsPrefix+"canvas-tooltip");__translation=[{x:0,y:0}];__main;__master;__focusedLayers;get focusedLayers(){return this.__focusedLayers}__view;__layerWrapper=document.createElement("div");__pointerPos={down:null,move:null,hover:null};__lastTouchDistance=-1;__eventTargets=[];__canvasMargin={x:0,y:0};__dimension={initial:{width:0,height:0},zoomed:{width:0,height:0}};setInitialDimension(value){this.__dimension.initial=value,this.__calcZoomedDimension(),this.setZoomLevel(this.__zoomLevel,!1),this.__focusedLayers.setFocusedZoom(this.__zoomLevel),this.__showUpdatedViewInfo()}getCssScaling(){const boundingRect=this.getBoundingClientRect();return{x:boundingRect.width/this.offsetWidth,y:boundingRect.height/this.offsetHeight}}__calcZoomedDimension(){this.__dimension.zoomed.width=this.__dimension.initial.width*this.__zoomLevel,this.__dimension.zoomed.height=this.__dimension.initial.height*this.__zoomLevel}initDrawing(){this.clearCanvas(),this.__applyZoomedDimension()}update(){this.__focusedLayers.erase(),this.clearCanvas()}__applyZoomedDimension(){this.__calcZoomedDimension()}__shift={x:0,y:0};__zoomLevel=1;__zoomLevelLimits={max:2,min:0};__drawingInfo=document.createElement("div");__absoluteMinZoomLevel=.01;addZoomLevel(zoomModification,checkLimits=!1){let newZoomLevel=0;void 0!==zoomModification&&(newZoomLevel=Math.max(this.__zoomLevel+zoomModification,this.__absoluteMinZoomLevel)),checkLimits&&(newZoomLevel=this.__zoomLevel<this.__zoomLevelLimits.min?zoomModification&&zoomModification<0?this.__zoomLevel:Math.min(newZoomLevel,this.__zoomLevelLimits.max):zoomModification&&zoomModification>0?this.__zoomLevel:Math.max(newZoomLevel,this.__zoomLevelLimits.min));const appliedRelZoomLevel=newZoomLevel-this.__zoomLevel;return this.setZoomLevel(newZoomLevel,!1),this.__showUpdatedViewInfo(),appliedRelZoomLevel}setZoomLevel(zoomLevel,checkLimits=!0){null===zoomLevel?zoomLevel=this.__zoomLevelLimits.min:(zoomLevel=Math.max(zoomLevel,this.__absoluteMinZoomLevel),checkLimits&&(this.__zoomLevelLimits.min>zoomLevel&&(zoomLevel=this.__zoomLevelLimits.min),this.__zoomLevelLimits.max<zoomLevel&&(zoomLevel=this.__zoomLevelLimits.max))),this.__focusedLayers.setFocusedZoom(zoomLevel),this.__zoomLevel=zoomLevel,this.__calcZoomedDimension()}__showUpdatedViewInfo(){this.__drawingInfo.dataset.timeout&&(this.__drawingInfo.textContent="",clearTimeout(parseInt(this.__drawingInfo.dataset.timeout,10)),delete this.__drawingInfo.dataset.timeout);const localizedInfo=this.__main.getLocalization().createLocalizedElement(`{{View_Updated.bold}} X: ${Math.round(this.__shift.x)}, Y: ${Math.round(this.__shift.y)}, {{Zoom}}: ${Math.round(100*this.__zoomLevel)} %`);this.__drawingInfo.append(localizedInfo),this.__drawingInfo.dataset.timeout=setTimeout(()=>{this.__drawingInfo.textContent="",delete this.__drawingInfo.dataset.timeout},5e3).toString()}destroy(){this.__tooltip.destroy()}__findTargetByPosition(pos){const canvasGlobalOffset=getGlobalOffset(this.__focusedLayers.getCanvas(LayerName.frame)),canvasPos_x=canvasGlobalOffset.left,canvasPos_y=canvasGlobalOffset.top,pointerPos_x=pos.x,pointerPos_y=pos.y,cssScaling=this.getCssScaling(),relPos_x=(-this.__shift.x/window.devicePixelRatio+(pointerPos_x-canvasPos_x+this.scrollLeft)/cssScaling.x)/this.__zoomLevel,relPos_y=(-this.__shift.y/window.devicePixelRatio+(pointerPos_y-canvasPos_y+this.scrollTop)/cssScaling.y)/this.__zoomLevel;for(const eventTarget of this.__eventTargets.reverse())if(relPos_x>=eventTarget.x&&relPos_x<eventTarget.x+eventTarget.w&&relPos_y>=eventTarget.y&&relPos_y<eventTarget.y+eventTarget.h)return eventTarget;return null}__obeyClick=!1;__handleClick=e=>{if(this.__obeyClick){const eventTarget=this.__findTargetByPosition({x:e.clientX,y:e.clientY});eventTarget&&eventTarget.primaryPointerFn&&eventTarget.primaryPointerFn()}};__handleContextMenu=e=>{const eventTarget=this.__findTargetByPosition({x:e.clientX,y:e.clientY});eventTarget&&(eventTarget.secondaryPointerFn?eventTarget.secondaryPointerFn():eventTarget.primaryPointerFn&&eventTarget.primaryPointerFn(),e.preventDefault())};drawMaster(master,layers){if(!store.appearance)return void TcHmi.Log.error("Appearance is null.");const target=master.target,ctx=layers.getContext(LayerName.text),dimension=master.design.dimension;this.drawFrame(dimension,layers,!0);const availableDimension_height=400;ctx.font=`50px ${store.appearance.fontFamily}`,ctx.fillStyle=store.appearance.master.textColor.getRGBAString(),ctx.textAlign="left",ctx.textBaseline="top",ctx.fillText(target.name,20,availableDimension_height*(1/3)),this.drawStatusFlag(master,layers),ctx.beginPath();let adsText="Error";switch(target.sysServiceAdsState){case 5:adsText="Run",ctx.fillStyle=store.appearance.adsState.run.getRGBAString();break;case 15:adsText="Config",ctx.fillStyle=store.appearance.adsState.config.getRGBAString();break;default:ctx.fillStyle=store.appearance.adsState.error.getRGBAString(),adsText="Error"}ctx.fillRect(20,availableDimension_height*(2/3),50,50),ctx.fillText(adsText,100,availableDimension_height*(2/3))}drawSlave(slave,layers,drawingDimension=void 0){if(!store.appearance)return void TcHmi.Log.error("Appearance is null.");const design=slave.design,ctxFrame=layers.getContext(LayerName.frame),slaveIsActive=slave.isPresent&&!slave.isDisabled;if(slaveIsActive){this.drawStatusFlag(slave,layers);const inputPort=slave.getPortByIndex(PortName.A);if(inputPort.isEBus&&inputPort.state===PortStates.error){const ctxError=layers.getContext(LayerName.error);ctxError.strokeStyle=store.appearance.port.EBus.error.border.color.getRGBAString(),ctxError.lineWidth=store.appearance.port.EBus.error.border.width,ctxError.beginPath(),ctxError.moveTo(0,0),ctxError.lineTo(0,design.dimension.height),ctxError.stroke()}if(slave.outgoingEBusPort&&slave.outgoingEBusPort.state===PortStates.error){const ctxError=layers.getContext(LayerName.error);ctxError.strokeStyle=store.appearance.port.EBus.error.border.color.getRGBAString(),ctxError.lineWidth=store.appearance.port.EBus.error.border.width,ctxError.beginPath(),ctxError.moveTo(design.dimension.width,0),ctxError.lineTo(design.dimension.width,design.dimension.height),ctxError.stroke()}this.drawErrorLabels(slave,layers)}let dimension=design.dimension;void 0!==drawingDimension&&(dimension=drawingDimension),this.drawFrame(dimension,layers,slaveIsActive,design.color);let labelWarningLevel=0;slave.hasInvalidIdentity&&(labelWarningLevel=2,(slave.hasInvalidIdentityBefore||slave.hasNotPresentSlavesBefore)&&(labelWarningLevel=1));const memberNameShort=slave.staticInfo.identity.vendor.memberNameShort.value;let type=slave.staticInfo.identity.type.value;if(null===memberNameShort||null===type)return;""===type&&(type=slave.staticInfo.identity.name.value);const labelVendorText=memberNameShort.slice(0,8),labelPos={x:10,y:design.dimension.height-store.appearance.slave.label.height};this.drawLabel(labelPos,design,labelVendorText,type,labelWarningLevel,layers,slaveIsActive),ctxFrame.globalAlpha=1;for(const port of slave.cableLinkPorts)this.drawPort(port.pos.rel,!1,port.state,layers)}drawFrame(dimension,layers,componentIsActive,color){if(!store.appearance)return void TcHmi.Log.error("Appearance is null.");const ctx=layers.getContext(LayerName.frame);ctx.beginPath(),ctx.rect(0,0,dimension.width,dimension.height),ctx.fillStyle=componentIsActive?store.appearance.slave.frame.bgColor.getRGBAString():store.appearance.slave.frame.bgColorDisabled.getRGBAString(),ctx.fill(),ctx.strokeStyle=store.appearance.slave.frame.border.color.getRGBAString(),ctx.lineWidth=store.appearance.slave.frame.border.width,ctx.stroke()}drawLabel(labelPos,design,manufacturer,type,warningLevel=0,layers,componentIsActive){if(!store.appearance)return void TcHmi.Log.error("Appearance is null.");const ctxText=layers.getContext(LayerName.text),shortedType=Slave.getShortSlaveType(type);ctxText.beginPath(),ctxText.font=`18px ${store.appearance.fontFamily}`,ctxText.textAlign="left",ctxText.textBaseline="top",ctxText.fillStyle=(componentIsActive?store.appearance.slave.frame.bgColor:store.appearance.slave.frame.bgColorDisabled).getRGBAString(.7);switch(ctxText.fillRect(labelPos.x-4,labelPos.y-16,design.dimension.width-16,store.appearance.slave.label.height),ctxText.beginPath(),warningLevel){case 0:ctxText.fillStyle=store.appearance.slave.label.noError.textColor.getRGBAString();break;case 1:ctxText.fillStyle=store.appearance.slave.label.vprsWarning.textColor.getRGBAString();break;case 2:ctxText.fillStyle=store.appearance.slave.label.vprsError.textColor.getRGBAString();break;default:ctxText.fillStyle=store.appearance.msgLevel.fallback.getRGBAString(),TcHmi.Log.error("Unknown warning level while drawing slave label. For fallback reason we will draw the slave label black.")}ctxText.fillText(shortedType,labelPos.x,labelPos.y),ctxText.fillText(manufacturer,labelPos.x,labelPos.y+25)}drawErrorLabels(slave,layers){const labels=slave.onlineData.labels,dimension=slave.design.dimension,labelPos={x:0,y:dimension.height};for(const label of labels)this.__addEventTarget({relativePos:labelPos,dimension:{width:dimension.width,height:45},hoverText:label.text}),this.drawErrorLabel(label,labelPos,dimension.width,layers)}drawErrorLabel(label,labelPos,labelWidth,layers){if(!store.appearance)return void TcHmi.Log.error("Appearance is null.");const ctx=layers.getContext(LayerName.text);ctx.beginPath();let labelBgColor=ColorRGBA_Black,labelTextColor=ColorRGBA_White;switch(label.warningLevel){case 3:labelBgColor=store.appearance.slave.attachedLabel.error.bgColor,labelTextColor=store.appearance.slave.attachedLabel.error.textColor;break;case 2:labelBgColor=store.appearance.slave.attachedLabel.warning.bgColor,labelTextColor=store.appearance.slave.attachedLabel.warning.textColor}ctx.fillStyle=labelBgColor.getRGBAString(),ctx.fillRect(labelPos.x,labelPos.y,labelWidth,45);const centerPosOfLabel={x:labelPos.x+labelWidth/2,y:labelPos.y+22.5};ctx.fillStyle=labelTextColor.getRGBAString(),ctx.textBaseline="middle",ctx.textAlign="center";let fontSize=28,textFitIn=!1;for(;!textFitIn;)ctx.font=`${fontSize}px ${store.appearance.fontFamily}`,textFitIn=ctx.measureText(label.text).width<labelWidth-30,fontSize-=2;ctx.fillText(label.text,centerPosOfLabel.x,centerPosOfLabel.y),labelPos.y+=45}drawPort(pos,hotConnect=!1,state=0,layers){if(!store.appearance)return void TcHmi.Log.error("Appearance is null.");const ctx=layers.getContext(LayerName.frame);if(layers.saveContext(),layers.translateAll(pos.x,pos.y),ctx.beginPath(),2===state)ctx.strokeStyle=store.appearance.port.PHY.error.border.color.getRGBAString(),ctx.fillStyle=store.appearance.port.PHY.error.bgColor.getRGBAString(),ctx.lineWidth=store.appearance.port.PHY.error.border.width;else ctx.strokeStyle=store.appearance.port.PHY.noError.border.color.getRGBAString(),ctx.fillStyle=store.appearance.port.PHY.noError.bgColor.getRGBAString(),ctx.lineWidth=store.appearance.port.PHY.noError.border.width;ctx.rect(-store.appearance.port.PHY.dimension.width/2,-store.appearance.port.PHY.dimension.height/2,store.appearance.port.PHY.dimension.width,store.appearance.port.PHY.dimension.height),ctx.fill(),ctx.stroke(),layers.restoreContext()}__drawCurrentState(component,layers,state){if(!store.appearance)return void TcHmi.Log.error("Appearance is null.");const ctx=layers.getContext(LayerName.text);if(null!=state){let componentWidth=100;component&&(componentWidth=component.design.dimension.width),ctx.beginPath();const stateMachineStateType=StateMachineStateType[state],stateMachineColor=store.appearance.stateMachine[stateMachineStateType]?.bgColor;ctx.fillStyle=stateMachineColor?stateMachineColor.getRGBAString():"black",ctx.strokeStyle=store.appearance.statusFlag.border.color.getRGBAString(),ctx.lineWidth=store.appearance.statusFlag.border.width;const flagPos={x:0,y:-store.appearance.statusFlag.height};ctx.rect(flagPos.x,flagPos.y,componentWidth,store.appearance.statusFlag.height),ctx.fill(),ctx.stroke(),this.__addEventTarget({relativePos:flagPos,dimension:{width:componentWidth,height:store.appearance.statusFlag.height},hoverText:"{{Statemachine}}: "+stateMachineStateType})}}__drawForcedState(component,layers,couplerGroup=!1){if(!couplerGroup&&!component.hasForcedProcessData||component instanceof Slave&&couplerGroup&&!component.couplerGroupHasForcedProcessData())return;if(!store.appearance)return void TcHmi.Log.error("Appearance is null.");const componentWidth=component.design.dimension.width,ctx=layers.getContext(LayerName.text);ctx.save(),ctx.beginPath();const center={x:componentWidth/2,y:-48};ctx.arc(center.x,center.y,18,0,2*Math.PI),ctx.fillStyle="rgb(230, 115, 0)",ctx.fill(),ctx.beginPath(),ctx.textAlign="center",ctx.textBaseline="middle",ctx.fillStyle="white",ctx.font=`18px ${store.appearance.fontFamily}`,ctx.fillText("F",center.x,center.y),ctx.restore();let componentType=component?.constructor.name;couplerGroup&&(componentType="CouplerGroup"),this.__addEventTarget({relativePos:{x:center.x-18,y:center.y-18},dimension:{width:36,height:36},hoverText:`{{Component_At_Least_One_Forced_Process_Data$${componentType}}}`})}drawStatusFlag(component,layers){let state=null;component instanceof Master?state=component.data.online.stateMachine.code.value:component instanceof Slave&&(state=component.data.online.current.stateMachine.code.value),null!==state&&this.__drawCurrentState(component,layers,state),this.__drawForcedState(component,layers)}clearCanvas(){this.__eventTargets=[]}__originPosition={x:0,y:0};__translatePositionStack=[];__translateOrigin(layers,pos){this.__originPosition={x:this.__originPosition.x+pos.x,y:this.__originPosition.y+pos.y},this.__translatePositionStack.push(pos),layers.translateAll(pos.x,pos.y)}__revertOriginTranslation(layers){const revertPosition=this.__translatePositionStack.pop();revertPosition?(this.__originPosition={x:this.__originPosition.x-revertPosition.x,y:this.__originPosition.y-revertPosition.y},layers.translateAll(-revertPosition.x,-revertPosition.y)):TcHmi.Log.error("No translation to revert.")}__addEventTarget(value){const position={x:this.__originPosition.x,y:this.__originPosition.y};value.relativePos&&(position.x+=value.relativePos.x,position.y+=value.relativePos.y),this.__eventTargets.push({x:position.x,y:position.y,w:value.dimension.width,h:value.dimension.height,target:value.target,hoverText:value.hoverText,primaryPointerFn:value.primaryPointerFn,secondaryPointerFn:value.secondaryPointerFn})}__multilineText(ctx,pos,text,desiredFontSize,maxDimension){if(!store.appearance)return void TcHmi.Log.error("Appearance is null.");const words=text.split(" ");let fontSize=desiredFontSize,wordMatrix=[];let fillWordsFailed=!1;for(;fontSize>4;){ctx.font=`${fontSize}px ${store.appearance.fontFamily}`;let rowWidth=0;fillWordsFailed=!1,wordMatrix=[""];for(const word of words){const wordWidth=ctx.measureText(word).width;if(rowWidth+wordWidth<=maxDimension.width)wordMatrix[wordMatrix.length-1]+=word+" ",rowWidth+=1+wordWidth;else{if((wordMatrix.length+1)*fontSize+30*(wordMatrix.length+1)>maxDimension.height){fillWordsFailed=!0;break}if(!(wordWidth<=maxDimension.width)){fillWordsFailed=!0;break}wordMatrix.push(word),rowWidth=wordWidth+1}}if(!fillWordsFailed)break;fontSize-=2}if(fillWordsFailed)return void TcHmi.Log.warn(`Text '${text}' does not fit into space with font size ${fontSize}.`);let rowOffset=0;for(const wordsOfRow of wordMatrix)ctx.fillText(wordsOfRow,pos.x,pos.y+rowOffset),rowOffset+=30}}