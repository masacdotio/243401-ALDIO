import{Slave}from"./Slave.js";import{NotificationLevel}from"./Notifications.js";export class Port{constructor(component,index,data,connection,slaveTerminalGroup,subSlaves){if(this.__component=component,this.__master=component.master,this.__index=index,this.__configured=data.configured,this.__configured&&(this.__configuredSlaveData=data.configuredSlave??null),this.__connection=connection,this.__redundancy=data.redundancy??!1,this.__redundancyPath=data.redundancyPath??!1,this.__redundancy){component.redundancyPort=this,this.__redundancy=!0;const redundancyConnection={outPort:this,state:-1,inPort:null},masterRedundancyPort=new PortMaster(this.__master,0,1,redundancyConnection);redundancyConnection.inPort=masterRedundancyPort,this.__connection=redundancyConnection,this.__master.setPort(0,masterRedundancyPort)}if(this.__physic=data.physic,0===index){this.__connection&&(this.__connection.inPort=this),this.__defineIncoming();const topology=this.__component.topology;if(!topology)return;topology.addPortToChronologicalPortList(this)}else this.__defineOutgoing(),this.__configured&&!this.__redundancy&&this.__initNext(slaveTerminalGroup,subSlaves)}__connection;get connection(){return this.__connection}__state=PortStates.notInitialized;get state(){return this.__state}set state(value){this.__state=value}__isCableLink=!1;get isCableLink(){return this.__isCableLink}__isEBus=!1;get isEBus(){return this.__isEBus}__exists=!1;get exists(){return this.__exists}__hotConnectGroupStart=!1;get hotConnectGroupStart(){return this.__hotConnectGroupStart}__orientation=PortOrientation.nirvana;get orientation(){return this.__orientation}__defineIncoming(){switch(this.__connection&&(this.__configuredComponent=this.__connection.outPort.component),this.__component instanceof Slave&&this.__component.data.EtherCAT.hotConnect.isHotConnectHead&&(this.__hotConnectGroupStart=!0),this.__orientation=PortOrientation.left,this.__physic){case PortPhysic.NONE:break;case PortPhysic.MII:case PortPhysic.FastHotConnect:this.__exists=!0,this.__isCableLink=!0;const cableLinkIndex=this.__component.addCableLinkPort(this);this.__evaluateAlignment(cableLinkIndex);break;case PortPhysic.EBUS:this.__exists=!0,this.__isEBus=!0,this.__pos.rel={x:0,y:200};break;default:TcHmi.Log.error(`Invalid type '${this.__physic}' of incoming port.`)}}__defineOutgoing(){switch(this.__physic){case PortPhysic.NONE:break;case PortPhysic.MII:case PortPhysic.FastHotConnect:this.__exists=!0,this.__isCableLink=!0;const cableLinkIndex=this.__component.addCableLinkPort(this);if(this.__evaluateAlignment(cableLinkIndex),!this.__configured)break;const outgoingConfiguredCableLinkIndex=this.__component.addOutgoingConfiguredCableLinkPort(this);switch(outgoingConfiguredCableLinkIndex){case 0:this.__component.hasIncomingCableLinkPort&&this.__component.hasOutgoingConfiguredEBusPort&&1===this.__component.numOfOutgoingConfiguredCableLinkPorts?this.__orientation=PortOrientation.down:this.__component.hasOutgoingConfiguredEBusPort||3===this.__component.numOfOutgoingConfiguredCableLinkPorts?this.__orientation=PortOrientation.up:this.__orientation=PortOrientation.right;break;case 1:3===this.__component.numOfOutgoingConfiguredCableLinkPorts?this.__orientation=PortOrientation.right:this.__orientation=PortOrientation.down;break;case 2:this.__orientation=PortOrientation.down;break;default:TcHmi.Log.error(`Invalid outgoingConfiguredCableLinkIndex '${outgoingConfiguredCableLinkIndex}' should be between 0 and 2 because maximum number of outgoing ports is 3.`)}break;case PortPhysic.EBUS:this.__exists=!0,this.__isEBus=!0,this.__orientation=PortOrientation.right,this.__pos.rel={x:this.__component.design.dimension.width,y:200},this.__component.outgoingEBusPort=this,this.__configured&&(this.__component.outgoingConfiguredEBusPort=this);break;default:TcHmi.Log.error(`Invalid type '${this.__physic}' of outgoing port.`)}}__evaluateAlignment(cableLinkIndex){if(!this.__alignment)if(this.__alignment={col:0,row:0,colspan:1,rowspan:1},this.__component.hasIncomingCableLinkPort&&this.__component.hasOutgoingConfiguredEBusPort&&this.__component.numOfOutgoingConfiguredCableLinkPorts>1)switch(cableLinkIndex){case 0:this.__alignment={col:0,row:1,colspan:1,rowspan:1};break;case 1:this.__alignment={col:0,row:0,colspan:1,rowspan:1};break;case 2:this.__alignment={col:0,row:2,colspan:1,rowspan:1};break;case 3:this.__alignment={col:0,row:3,colspan:1,rowspan:1};break;default:TcHmi.Log.error(`Invalid cableLink index '${cableLinkIndex}'. CableLink index should be between 0 and 3 because max number of ports is 4.`)}else switch(cableLinkIndex){case 0:this.__alignment={col:0,row:0,colspan:1,rowspan:1};break;case 1:this.__alignment={col:0,row:1,colspan:1,rowspan:1};break;case 2:this.__alignment={col:0,row:2,colspan:1,rowspan:1};break;case 3:this.__alignment={col:0,row:3,colspan:1,rowspan:1};break;default:TcHmi.Log.error(`Invalid cableLink index '${cableLinkIndex}'. CableLink index should be between 0 and 3 because max number of ports is 4.`)}const interior=this.__component.design.interior,sectionDimension_width=interior.dimension.width/interior.section.cols,sectionDimension_height=interior.dimension.height/interior.section.rows;this.__pos.rel={x:interior.offset.x+sectionDimension_width*this.__alignment.col+sectionDimension_width*this.__alignment.colspan/2,y:interior.offset.y+sectionDimension_height*this.__alignment.row+sectionDimension_height*this.__alignment.rowspan/2}}__initNext(slaveTerminalGroup,subSlaves){const topology=this.__component.topology;if(null===topology)return;let nextTrace=this.__component.trace;(this.__isCableLink||this.__isEBus&&null===nextTrace)&&(nextTrace=topology.addTrace(),this.__nextTrace=nextTrace),null!==nextTrace?(this.__connection={outPort:this,inPort:null,state:PortStates.notInitialized},this.__configuredSlaveData&&(this.__isEBus||(slaveTerminalGroup=null),this.__nextSlave=new Slave(this.__configuredSlaveData,nextTrace,this.__connection,slaveTerminalGroup,subSlaves),topology.addPortToChronologicalPortList(this),this.__configuredComponent=this.__nextSlave)):TcHmi.Log.error("Unable to find or create trace.")}__pos={rel:{x:0,y:0},slave:null,trace:null,network:{x:0,y:0}};get pos(){return this.__pos}__configuredSlaveData=null;__configuredComponent=null;get configuredComponent(){return this.__configuredComponent}__nextSlave=null;get nextSlave(){return this.__nextSlave}__nextTrace=null;get nextTrace(){return this.__nextTrace}get offsetNextSlave(){const offset={x:0,y:0};return this.isCableLink&&(offset.x+=200),offset}__alignment=null;__component;get component(){return this.__component}__master;__index;get index(){return this.__index}__configured;get configured(){return this.__configured}__physic;get physic(){return this.__physic}get typeName(){return PortPhysic[this.__physic]}__redundancy;get redundancy(){return this.__redundancy}__redundancyPath;get redundancyPath(){return this.__redundancyPath}}export class PortMaster extends Port{constructor(master,index,physic,connection,configuredSlaveData=null){let redundancyPath=!1;if(configuredSlaveData)for(const configuredSlavePort of configuredSlaveData.ports)if(redundancyPath=(configuredSlavePort.redundancy??!1)||(configuredSlavePort.redundancyPath??!1),redundancyPath)break;super(master,index,{autoIncAddr:0,index,configured:!0,configuredSlave:configuredSlaveData,redundancy:!1,redundancyPath,physic},connection,null,[])}}export class PortSlave extends Port{constructor(slave,index,portData,connection,slaveTerminalGroup,subSlaves){super(slave,index,portData,connection,slaveTerminalGroup,subSlaves)}__online={current:{unexpectedLink:{value:null,domElements:new Set},missingLink:{value:null,domElements:new Set},linkError:{value:null,domElements:new Set}},counter:{crc:{total:{value:null,domElements:new Set},errorOnPrevPort:{value:null,domElements:new Set}}},messages:{value:new Set,domElements:new Set}};get online(){return this.__online}addMessage(localization,contentKeys,errorLevel){const el=document.createElement("div");switch(el.classList.add("slave-message"),errorLevel){case NotificationLevel.info:case NotificationLevel.success:break;case NotificationLevel.warning:el.classList.add("slave-message-warning");break;case NotificationLevel.error:el.classList.add("slave-message-error");break;default:TcHmi.Log.error("Invalid error level.")}for(const contentKey of contentKeys){const subEl=document.createElement("div");localization.addElement(subEl,contentKey),el.append(subEl)}this.__online.messages.value.add(el)}clearMessages(){this.__online.messages.value=new Set}updateMessages(){if(this.__online.messages.domElements?.size)for(const msgEl of this.__online.messages.domElements){msgEl.innerHTML="";for(const errEl of this.__online.messages.value)msgEl.appendChild(errEl)}}}export var PortStates;!function(PortStates){PortStates[PortStates.notInitialized=-1]="notInitialized",PortStates[PortStates.noError=0]="noError",PortStates[PortStates.notPresent=1]="notPresent",PortStates[PortStates.error=2]="error"}(PortStates||(PortStates={}));export var PortPhysic;!function(PortPhysic){PortPhysic[PortPhysic.NONE=0]="NONE",PortPhysic[PortPhysic.MII=1]="MII",PortPhysic[PortPhysic.EBUS=3]="EBUS",PortPhysic[PortPhysic.FastHotConnect=4]="FastHotConnect"}(PortPhysic||(PortPhysic={}));export var PortName;!function(PortName){PortName[PortName.A=0]="A",PortName[PortName.D=1]="D",PortName[PortName.B=2]="B",PortName[PortName.C=3]="C"}(PortName||(PortName={}));export var PortOrientation;!function(PortOrientation){PortOrientation[PortOrientation.nirvana=0]="nirvana",PortOrientation[PortOrientation.left=1]="left",PortOrientation[PortOrientation.right=2]="right",PortOrientation[PortOrientation.up=3]="up",PortOrientation[PortOrientation.down=4]="down"}(PortOrientation||(PortOrientation={}));