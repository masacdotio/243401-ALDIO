import{customElementsPrefix,extensionName}from"../../Defines.js";import{addDomElement}from"../../DOMUtility.js";import{AdsState}from"../SlaveListView/SlaveListView.js";import{Notifications,NotificationLevel}from"../../Notifications.js";import"../OptionalBoolInput/OptionalBoolInput.js";import{store}from"../../Appearance.js";import*as Utility from"../../Utility.js";export class ProcessDataView extends HTMLElement{constructor(slave,localization){if(!slave||!localization)throw new Error("Required parameters `slave` and `localization` are missing or undefined. The constructor is probably called by document.createElement() or the html tag and therefore no parameters were passed.");super(),this.__slave=slave,this.__localization=localization,this.__ecdiagnostics=this.__slave.main}connectedCallback(){this.__init(),this.__slave.subscribeToProcessDataValues(),this.__slave.master.target.addTargetSysServiceAdsStateOnChangeFn(this.__onTargetAdsSysServiceChange)}disconnectedCallback(){this.__localization.cleanUp(),this.__slave.unsubscribeProcessValueSubscription(),this.__slave.master.target.removeTargetSysServiceAdsStateOnChangeFn(this.__onTargetAdsSysServiceChange),this.__allForceBtns=[],this.__allReleaseBtns=[]}__ecdiagnostics;__slave;__localization;__pdo_types=[{key:"input",label:"Input"},{key:"output",label:"Output"}];__allForceBtns=[];__allReleaseBtns=[];__onTargetAdsSysServiceChange=targetSysServiceAdsState=>{if(this.__messageWrapper.textContent="",this.__slave.main.getSymbolAccess(`${extensionName}.ForceProcessDataValues`)||this.__slave.main.getSymbolAccess(`${extensionName}.ReleaseProcessDataValues`)){const disable=targetSysServiceAdsState!==AdsState.run;for(const btn of[...this.__allForceBtns,...this.__allReleaseBtns])btn.toggleAttribute("disabled",disable);disable&&this.__messageWrapper.append(Notifications.createErrorElement(this.__slave.main,this.__localization,"{{Msg_Process_Data_Forcing_And_Releasing_Only_Available_In_Run_Mode}}",NotificationLevel.warning))}};__createTableHeaders(){const headline=document.createElement("div");headline.classList.add("headline","grid-full-row"),this.append(headline);const pdos=this.__slave.processData;if(pdos){headline.append(this.__localization.createLocalizedElement(`{{Slave_Processdata.bold}} ({{Input}}: ${pdos.input.length}, {{Output}}: ${pdos.output.length})`)),this.__messageWrapper.classList.add("grid-full-row"),this.append(this.__messageWrapper);const gridHeaderName=document.createElement("div");gridHeaderName.classList.add("entry-cell"),this.__localization.addElement(gridHeaderName,"Slave_Processdata_Name");const gridHeaderType=document.createElement("div");gridHeaderType.classList.add("entry-cell"),this.__localization.addElement(gridHeaderType,"Slave_Processdata_Type");const gridHeaderSize=document.createElement("div");gridHeaderSize.classList.add("entry-cell"),this.__localization.addElement(gridHeaderSize,"Slave_Processdata_Size");const gridHeaderForceState=document.createElement("div");gridHeaderForceState.classList.add("entry-cell"),gridHeaderForceState.innerHTML='<span class="forced-process-data-value-flag-placeholder"></span>';const gridHeaderValue=document.createElement("span");if(gridHeaderValue.classList.add("entry-cell"),this.__localization.addElement(gridHeaderValue,"Slave_Processdata_Value"),this.append(gridHeaderName,gridHeaderType,gridHeaderSize,gridHeaderForceState,gridHeaderValue),this.__slave.main.getSymbolAccess(`${extensionName}.SetProcessDataValues`)||this.__slave.main.getSymbolAccess(`${extensionName}.ForceProcessDataValues`)){const gridHeaderPreparedValue=document.createElement("div");gridHeaderPreparedValue.classList.add("entry-cell"),this.__localization.addElement(gridHeaderPreparedValue,"Slave_Processdata_Prepared_Value"),this.append(gridHeaderPreparedValue)}if(this.__slave.main.getSymbolAccess(`${extensionName}.SetProcessDataValues`)){const gridHeaderSetAllBtn=document.createElement("div");gridHeaderSetAllBtn.classList.add("entry-cell");const setAllBtn=this.__ecdiagnostics.createStatusButton("Slave_Processdata_Set_All");setAllBtn.classList.add("entry-cell-element"),setAllBtn.addEventListener("click",this.__setAllValues.bind(this,setAllBtn)),gridHeaderSetAllBtn.append(setAllBtn),this.append(gridHeaderSetAllBtn)}if(this.__slave.main.getSymbolAccess(`${extensionName}.ForceProcessDataValues`)){const gridHeaderForceAllBtn=document.createElement("div");gridHeaderForceAllBtn.classList.add("entry-cell");const forceAllBtn=this.__ecdiagnostics.createStatusButton("Slave_Processdata_Force_All");forceAllBtn.addEventListener("click",this.__forceAllValues.bind(this,forceAllBtn)),gridHeaderForceAllBtn.append(forceAllBtn),this.append(gridHeaderForceAllBtn),this.__allForceBtns.push(forceAllBtn)}if(this.__slave.main.getSymbolAccess(`${extensionName}.ReleaseProcessDataValues`)){const gridHeaderReleaseAllBtn=document.createElement("div");gridHeaderReleaseAllBtn.classList.add("entry-cell");const releaseAllBtn=this.__ecdiagnostics.createStatusButton("Slave_Processdata_Release_All");releaseAllBtn.addEventListener("click",this.__releaseAllValues.bind(this,releaseAllBtn)),gridHeaderReleaseAllBtn.append(releaseAllBtn),this.append(gridHeaderReleaseAllBtn),this.__allForceBtns.push(releaseAllBtn)}}else headline.append(this.__localization.createLocalizedElement("{{Slave_Processdata.bold}}: {{Slave_Processdata_No_Entries}}"))}__createTableEntries(){const pdos=this.__slave.processData;if(pdos)for(const pdo_type of this.__pdo_types){const pdos_io=pdos[pdo_type.key];if(!pdos_io)continue;const entryGroups={prev:{names:[],wrapper:[]},current:{names:[],wrapper:[]}};for(const processDataObject of pdos_io)for(const entry of processDataObject.entries){entry.value||(entry.value={value:null,domElements:new Set,forced:null,forcedDomElements:new Set,errorElements:new Set}),entryGroups.current.names=[processDataObject.name].concat(entry.name.split("__"));let wrapper=this;for(const[entryLayerIndex,entryLayerName]of entryGroups.current.names.entries())entryLayerIndex===entryGroups.current.names.length-1?this.__createTableEntry(wrapper,pdo_type.key,processDataObject.index,entry,entryLayerIndex,entryLayerName):wrapper=this.__createTableEntryParent(processDataObject,wrapper,pdo_type.key,entryLayerIndex,entryGroups);entryGroups.prev.names=entryGroups.current.names,entryGroups.prev.wrapper=entryGroups.current.wrapper}}}__createTableEntryParent(pdo,wrapper,pdo_type,layerIndex,entryGroups){const indent=20*layerIndex,cellEntryName=document.createElement("div");cellEntryName.classList.add("entry-cell"),cellEntryName.style.paddingLeft=`${indent}px`;const arrowMore=document.createElement("div");arrowMore.classList.add("arrow","arrow-right");const icon=document.createElement("span");icon.classList.add("entry-name-icon");const cellEntryLayerName=document.createElement("span");if(cellEntryLayerName.textContent=entryGroups.current.names[layerIndex],cellEntryName.append(arrowMore,icon,cellEntryLayerName),entryGroups.prev.names[layerIndex]===entryGroups.current.names[layerIndex])wrapper=entryGroups.current.wrapper[layerIndex]=entryGroups.prev.wrapper[layerIndex];else{const forcedProcessDataValueFlag=document.createElement("span");forcedProcessDataValueFlag.classList.add("channel-process-data-forced-flag","forced-process-data-value-flag","hide"),forcedProcessDataValueFlag.textContent="F",this.__localization.addElement(forcedProcessDataValueFlag,void 0,void 0,new Map([["title",{contentKey:"Component_At_Least_One_Forced_Process_Data",placeholders:["Channel"]}]])),pdo.atLeastOneEntryForcedDomElements??=new Set,pdo.atLeastOneEntryForcedDomElements.add(forcedProcessDataValueFlag);const subGroup=document.createElement("div");subGroup.classList.add("grid-sub-group"),subGroup.style.display="none",entryGroups.current.wrapper[layerIndex]=subGroup,wrapper.append(cellEntryName,forcedProcessDataValueFlag,subGroup),wrapper=subGroup,entryGroups.prev.names=entryGroups.prev.wrapper=[],cellEntryName.classList.add("channel-name"),0===layerIndex?icon.classList.add(`icon-${pdo_type}-channel`):entryGroups.current.names[layerIndex+1].startsWith("ARRAY ")?(entryGroups.current.names[layerIndex+1]=entryGroups.current.names[layerIndex+1].slice(6),icon.classList.add(`icon-${pdo_type}-array-entry`)):icon.classList.add(`icon-${pdo_type}-struct-entry`);let subOpened=!1;cellEntryName.addEventListener("click",()=>{arrowMore.classList.toggle("arrow-down",!subOpened),arrowMore.classList.toggle("arrow-right",subOpened),subOpened?subGroup.style.display="none":subGroup.style.removeProperty("display"),subOpened=!subOpened})}return wrapper}__createTableEntry(wrapper,pdoType,pdoIndex,entry,layerIndex,layerName){let indent=20*layerIndex;const cellEntryName=document.createElement("div");cellEntryName.classList.add("entry-cell","first"),cellEntryName.style.paddingLeft=`${indent}px`,indent+=20;const arrowMore=document.createElement("div");arrowMore.classList.add("arrow","arrow-right");const icon=document.createElement("span");icon.classList.add("entry-name-icon");const entryLayerName=document.createElement("span");entryLayerName.textContent=layerName,cellEntryName.append(arrowMore,icon,entryLayerName),wrapper.append(cellEntryName),icon.classList.add(`icon-${pdoType}-entry`);const cellEntryType=document.createElement("div");cellEntryType.textContent=entry.type,cellEntryType.classList.add("entry-cell");const cellEntryBitLength=document.createElement("div");cellEntryBitLength.classList.add("entry-cell"),cellEntryBitLength.classList.add("num"),cellEntryBitLength.textContent=entry.bitLength.toString();const localization=this.__slave.main.getLocalization(),cellForceState=document.createElement("div");cellForceState.classList.add("forced-process-data-value-flag-placeholder");const forceStateEl=document.createElement("span");forceStateEl.classList.add("forced-process-data-value-flag"),forceStateEl.textContent="F",localization.addElement(forceStateEl,void 0,void 0,new Map([["title",{contentKey:"Slave_Processdata_Value_Forced"}]])),cellForceState.append(forceStateEl),entry.value?.forcedDomElements.add(forceStateEl);const cellEntryValue=document.createElement("div");cellEntryValue.classList.add("entry-cell"),cellEntryValue.addEventListener("click",()=>{entry.showValueAsHex=!entry.showValueAsHex,this.__slave.updateProcessDataValuesOnlineElements(entry)}),cellEntryValue.classList.add("online-value"),cellEntryValue.textContent="-",wrapper.append(cellEntryType,cellEntryBitLength,cellForceState,cellEntryValue);const cellEntryError=document.createElement("div");cellEntryError.classList.add("grid-full-row"),cellEntryError.style.paddingLeft=`${indent}px`,cellEntryError.style.color="red";const entryReadErrorEl=document.createElement("div"),cbErrorEl=document.createElement("div");cbErrorEl.classList.add("entry-cell","hide"),cellEntryError.append(entryReadErrorEl,cbErrorEl),addDomElement("ExtendedInfoOfSlave",entry.value,cellEntryValue,entryReadErrorEl),this.__slave.updateProcessDataValuesOnlineElements(entry);let preparedValueInput=document.createElement("input");if(this.__slave.main.getSymbolAccess(`${extensionName}.SetProcessDataValues`)||this.__slave.main.getSymbolAccess(`${extensionName}.ForceProcessDataValues`)){const cellPreparedValue=document.createElement("div");preparedValueInput.classList.add("regular-text-input"),"BIT"===entry.type&&1===entry.bitLength?(preparedValueInput=document.createElement(customElementsPrefix+"optional-bool-input"),preparedValueInput.mapValue(entry.value)):"BIT"===entry.type||"BYTE"===entry.type||entry.type.endsWith("INT")||entry.type.endsWith("WORD")?preparedValueInput.setAttribute("data-tchmi-input-mode","numeric"):entry.type.endsWith("REAL")&&preparedValueInput.setAttribute("data-tchmi-input-mode","decimal"),entry.preparedValue=preparedValueInput,cellPreparedValue.append(preparedValueInput),cellPreparedValue.classList.add("entry-cell"),wrapper.append(cellPreparedValue)}if(this.__slave.main.getSymbolAccess(`${extensionName}.SetProcessDataValues`)){const cellSetValueBtn=document.createElement("div"),setValueBtn=this.__ecdiagnostics.createStatusButton("Slave_Processdata_Set");setValueBtn.addEventListener("click",()=>{this.__setValue(preparedValueInput,{button:setValueBtn,message:cbErrorEl},pdoType,pdoIndex,entry.index,entry.subIndex)}),cellSetValueBtn.append(setValueBtn),cellSetValueBtn.classList.add("entry-cell"),wrapper.append(cellSetValueBtn)}if(this.__slave.main.getSymbolAccess(`${extensionName}.ForceProcessDataValues`)){const cellForceValueBtn=document.createElement("div"),forceValueBtn=this.__ecdiagnostics.createStatusButton("Slave_Processdata_Force");forceValueBtn.classList.add("regular-button"),forceValueBtn.addEventListener("click",e=>{this.__forceValue(preparedValueInput,{button:forceValueBtn,message:cbErrorEl},pdoType,pdoIndex,entry.index,entry.subIndex)}),this.__allForceBtns.push(forceValueBtn),cellForceValueBtn.append(forceValueBtn),cellForceValueBtn.classList.add("entry-cell"),wrapper.append(cellForceValueBtn)}if(this.__slave.main.getSymbolAccess(`${extensionName}.ReleaseProcessDataValues`)){const cellReleaseValueBtn=document.createElement("div"),releaseValueBtn=this.__ecdiagnostics.createStatusButton("Slave_Processdata_Release");releaseValueBtn.classList.add("regular-button"),releaseValueBtn.addEventListener("click",()=>{this.__releaseValue({button:releaseValueBtn,message:cbErrorEl},pdoType,pdoIndex,entry.index,entry.subIndex)}),this.__allReleaseBtns.push(releaseValueBtn),cellReleaseValueBtn.append(releaseValueBtn),cellReleaseValueBtn.classList.add("entry-cell"),wrapper.append(cellReleaseValueBtn)}wrapper.append(cellEntryError);const cellProcessDataChart=document.createElement("div");cellProcessDataChart.style.padding="0px",cellProcessDataChart.style.paddingLeft=`${indent}px`,cellProcessDataChart.setAttribute("colSpan","10"),cellProcessDataChart.classList.add("grid-full-row","hide");const processDataChart_wrapper=document.createElement("div");processDataChart_wrapper.classList.add("process-data-chart-wrapper"),cellProcessDataChart.append(processDataChart_wrapper),wrapper.append(cellProcessDataChart);let processDataChart_hidden=!0;cellEntryName.addEventListener("click",()=>{processDataChart_hidden?(arrowMore.classList.remove("arrow-right"),arrowMore.classList.add("arrow-down"),cellProcessDataChart.classList.remove("hide"),this.__addProcessDataHistoryChart(processDataChart_wrapper,entry),processDataChart_hidden=!1):(arrowMore.classList.remove("arrow-down"),arrowMore.classList.add("arrow-right"),cellProcessDataChart.classList.add("hide"),this.__removeProcessDataHistoryChart(processDataChart_wrapper),processDataChart_hidden=!0)})}__messageWrapper=document.createElement("div");__init(){this.textContent="",this.__createTableHeaders(),this.__createTableEntries()}__setAllValues(button){const writeValues=[];if(this.__slave.processData){for(const[ioType,ioPdos]of Object.entries(this.__slave.processData))for(const pdo of ioPdos)for(const entry of pdo.entries){if(!entry.preparedValue){TcHmi.Log.error("Prepared value of entry is not defined (yet).");continue}const newValue=entry.preparedValue.value;if(null===newValue||""===newValue)continue;const writeValue={io:ioType,objectIndex:pdo.index,entryIndex:entry.index,entrySubIndex:entry.subIndex,entryValue:entry.preparedValue.value};writeValues.push(writeValue),entry.preparedValue.value=""}this.__slave.setProcessDataValues(writeValues,{button})}}__forceAllValues(button){const writeValues=[];if(this.__slave.processData){for(const[ioType,ioPdos]of Object.entries(this.__slave.processData))for(const pdo of ioPdos)for(const entry of pdo.entries){if(!entry.preparedValue){TcHmi.Log.error("Prepared value of entry is not defined (yet).");continue}const newValue=entry.preparedValue.value;if(null===newValue||""===newValue)continue;const writeValue={io:ioType,objectIndex:pdo.index,entryIndex:entry.index,entrySubIndex:entry.subIndex,entryValue:entry.preparedValue.value};writeValues.push(writeValue),entry.preparedValue.value=""}this.__slave.forceProcessDataValues(writeValues,{button})}}__releaseAllValues(button){const writeValues=[];if(this.__slave.processData){for(const[ioType,ioPdos]of Object.entries(this.__slave.processData))for(const pdo of ioPdos)for(const entry of pdo.entries){const writeValue={io:ioType,objectIndex:pdo.index,entryIndex:entry.index,entrySubIndex:entry.subIndex};writeValues.push(writeValue)}this.__slave.releaseProcessDataValues(writeValues,{button})}}__setValue(inputElement,cbErrorEl,io,objectIndex,entryIndex,entrySubIndex){const value=inputElement.value;null!==value&&(this.__slave.setProcessDataValues([{io,objectIndex,entryIndex,entrySubIndex,entryValue:value}],cbErrorEl),inputElement.value="",TcHmi.Log.info(`Value '${value}' applied.`))}__forceValue(inputElement,cbErrorEl,io,objectIndex,entryIndex,entrySubIndex){const value=inputElement.value;null!==value&&(this.__slave.forceProcessDataValues([{io,objectIndex,entryIndex,entrySubIndex,entryValue:value}],cbErrorEl),inputElement.value="",TcHmi.Log.info(`Value '${value}' forced.`))}__releaseValue(cbErrorEl,io,objectIndex,entryIndex,entrySubIndex){this.__slave.releaseProcessDataValues([{io,objectIndex,entryIndex,entrySubIndex}],cbErrorEl)}__addProcessDataHistoryChart(wrapper,entry){const infoEl=document.createElement("span"),canvas=document.createElement("canvas"),toggleHex=()=>{entry.showValueAsHex=!entry.showValueAsHex,this.__slave.updateProcessDataValuesOnlineElements(entry)};canvas.addEventListener("click",()=>{entry.historyChartShowValuesRange=!entry.historyChartShowValuesRange});const chartCurrentValue=document.createElement("div");chartCurrentValue.classList.add("label","current-value"),chartCurrentValue.dataset.valueOnly="true",chartCurrentValue.addEventListener("click",toggleHex);const minMaxMarker={min:document.createElement("div"),max:document.createElement("div")};minMaxMarker.min.classList.add("label","min-value"),minMaxMarker.max.classList.add("label","max-value"),minMaxMarker.min.addEventListener("click",toggleHex),minMaxMarker.max.addEventListener("click",toggleHex),minMaxMarker.min.classList.add("hide"),minMaxMarker.max.classList.add("hide"),chartCurrentValue.classList.add("hide"),canvas.classList.add("hide"),infoEl.classList.add("hide"),entry.value?.domElements.add(chartCurrentValue);const historyChartUpdateInterval=setInterval(()=>{this.__drawProcessDataHistoryChart(wrapper,canvas,entry,historyChartUpdateInterval,minMaxMarker,chartCurrentValue,infoEl)},50);this.__drawProcessDataHistoryChart(wrapper,canvas,entry,historyChartUpdateInterval,minMaxMarker,chartCurrentValue,infoEl),wrapper.append(minMaxMarker.min,minMaxMarker.max,chartCurrentValue,canvas,infoEl),this.__slave.updateProcessDataValuesOnlineElements(entry)}__drawProcessDataHistoryChart(wrapper,canvas,entry,historyChartUpdateInterval,minMaxMarker,currentValueEl,infoEl){const tsNow=Date.now();if(entry.historyChartsVisible||(entry.historyChartsVisible=new Set),0===wrapper.offsetWidth){if(entry.historyChartsVisible.delete(canvas),entry.historyValue?.splice(0,entry.historyValue.length-1),!wrapper.isConnected)return void clearInterval(historyChartUpdateInterval)}else entry.historyChartsVisible.add(canvas);if(!entry.historyValue)return minMaxMarker.min.classList.add("hide"),minMaxMarker.max.classList.add("hide"),currentValueEl.classList.add("hide"),canvas.classList.add("hide"),infoEl.textContent="No value data to display history chart.",void infoEl.classList.remove("hide");for(minMaxMarker.min.classList.remove("hide"),minMaxMarker.max.classList.remove("hide"),currentValueEl.classList.remove("hide"),canvas.classList.remove("hide"),infoEl.classList.add("hide");entry.historyValue.length>1&&entry.historyValue[1].ts+3e4<tsNow;)entry.historyValue.shift();const ctx=canvas.getContext("2d");ctx.imageSmoothingEnabled=!0;const canvasSize={width:wrapper.offsetWidth,height:wrapper.offsetHeight};canvas.style.position="absolute",canvas.width=canvasSize.width,canvas.height=canvasSize.height;const chartSize={width:canvasSize.width,height:canvasSize.height-10};ctx.setTransform(1,0,0,-1,0,chartSize.height+5),ctx.clearRect(0,-5,canvas.width,canvas.height),ctx.strokeStyle=store.appearance?.processData.historyChart.grid.lineColor.getHexString()??"black",ctx.lineWidth=store.appearance?.processData.historyChart.grid.lineWidth??1;const stepCount={x:store.appearance?.processData.historyChart.grid.numOfVerticalLines??1,y:store.appearance?.processData.historyChart.grid.numOfHorizontalLines??1},yOffsetBelow=store.appearance?.processData.historyChart.grid.yOffsetBelow??0,yOffsetAbove=store.appearance?.processData.historyChart.grid.yOffsetAbove??0;stepCount.y+=yOffsetBelow+yOffsetAbove;const stepSize_x=chartSize.width/stepCount.x,stepSize_y=chartSize.height/stepCount.y,secondsPerStep=30/stepCount.x,xOffset=-stepSize_x*(Date.now()/1e3%secondsPerStep/secondsPerStep);for(let i=0;i<=stepCount.x;i++)ctx.moveTo(xOffset+i*stepSize_x,0),ctx.lineTo(xOffset+i*stepSize_x,chartSize.height);for(let i=0;i<=stepCount.y;i++)ctx.moveTo(0,stepSize_y*i),ctx.lineTo(chartSize.width,stepSize_y*i);ctx.stroke();const drawingChartSize={width:chartSize.width,height:chartSize.height-stepSize_y*(yOffsetBelow+yOffsetAbove)};ctx.save(),ctx.translate(0,yOffsetBelow*stepSize_y),ctx.beginPath(),ctx.strokeStyle=store.appearance?.processData.historyChart.grid.minValue.lineColor.getHexString()??"black",ctx.lineWidth=store.appearance?.processData.historyChart.grid.minValue.lineWidth??1,ctx.moveTo(0,0),ctx.lineTo(chartSize.width,0),ctx.stroke(),ctx.beginPath(),ctx.strokeStyle=store.appearance?.processData.historyChart.grid.maxValue.lineColor.getHexString()??"black",ctx.lineWidth=store.appearance?.processData.historyChart.grid.maxValue.lineWidth??1,ctx.moveTo(0,drawingChartSize.height),ctx.lineTo(chartSize.width,drawingChartSize.height),ctx.stroke();let limit=null;let datatypeRange=null;if(["BIT","BIT2","UINT","USINT"].includes(entry.type)&&entry.bitLength?datatypeRange={min:0,max:Math.pow(2,entry.bitLength)-1}:["INT","DINT"].includes(entry.type)&&entry.bitLength&&(datatypeRange={min:-Math.pow(2,entry.bitLength)/2,max:Math.pow(2,entry.bitLength)/2-1}),!entry.historyChartShowValuesRange&&null!==datatypeRange||1===entry.bitLength)datatypeRange&&(limit={min:datatypeRange.min,max:datatypeRange.max});else for(const tsValue of entry.historyValue)null===limit?limit={min:tsValue.value,max:tsValue.value}:(limit.min=Math.min(limit.min,tsValue.value),limit.max=Math.max(limit.max,tsValue.value));if(null===limit)return void TcHmi.Log.error("Limit not set.");limit.min===limit.max&&(datatypeRange?.min!==limit.min&&(limit.min+=-1),datatypeRange?.max===limit.max&&limit.max!==limit.min||(limit.max+=1)),1===entry.bitLength?(minMaxMarker.min.textContent="false",minMaxMarker.max.textContent="true"):entry.showValueAsHex?(minMaxMarker.min.textContent=Utility.toHexString(limit.min),minMaxMarker.max.textContent=Utility.toHexString(limit.max),entry.historyChartShowValuesRange&&datatypeRange&&(minMaxMarker.min.textContent+=` (${Utility.toHexString(datatypeRange.min)})`,minMaxMarker.max.textContent+=` (${Utility.toHexString(datatypeRange.max)})`)):(minMaxMarker.min.textContent=limit.min.toString(10),minMaxMarker.max.textContent=limit.max.toString(10),entry.historyChartShowValuesRange&&datatypeRange&&(minMaxMarker.min.textContent+=` (${datatypeRange.min})`,minMaxMarker.max.textContent+=` (${datatypeRange.max})`));const yRange=Math.abs(limit.max-limit.min);if(limit.max>0&&limit.min<0&&1!==entry.bitLength){const zeroRelativeYValue=(0-limit.min)/yRange*drawingChartSize.height;ctx.beginPath(),ctx.strokeStyle=store.appearance?.processData.historyChart.grid.zeroValue.lineColor.getHexString()??"black",ctx.lineWidth=store.appearance?.processData.historyChart.grid.zeroValue.lineWidth??1,ctx.moveTo(0,zeroRelativeYValue),ctx.lineTo(drawingChartSize.width,zeroRelativeYValue),ctx.stroke()}let oldYValue=null;ctx.beginPath();let point=null,preForced=null;for(const tsValue of entry.historyValue){const tsDiff=(tsNow-tsValue.ts)/1e3,xValue=Math.max(drawingChartSize.width/30*(30-tsDiff),-1),relativeYValue=(tsValue.value-limit.min)/yRange;if(null!==oldYValue&&(ctx.lineTo(xValue,oldYValue),ctx.stroke()),point={x:xValue,y:relativeYValue*drawingChartSize.height},preForced!==tsValue.forced){let color=store.appearance?.processData.historyChart.releasedValue.color.getHexString(),lineWidth=store.appearance?.processData.historyChart.releasedValue.width;tsValue.forced&&(color=store.appearance?.processData.historyChart.forcedValue.color.getHexString(),lineWidth=store.appearance?.processData.historyChart.forcedValue.width,ctx.stroke(),ctx.beginPath(),ctx.strokeStyle=color??"black",ctx.lineWidth=lineWidth??1),null!==oldYValue&&ctx.moveTo(xValue,oldYValue),ctx.lineTo(xValue,point.y),tsValue.forced||(ctx.stroke(),ctx.beginPath()),null!==point&&ctx.moveTo(point.x,point.y),ctx.strokeStyle=color??"black",ctx.lineWidth=lineWidth??1}else ctx.lineTo(xValue,point.y);oldYValue=relativeYValue*drawingChartSize.height,preForced=tsValue.forced}null!==oldYValue&&ctx.lineTo(drawingChartSize.width,oldYValue),ctx.stroke(),ctx.restore()}__removeProcessDataHistoryChart(wrapper){wrapper.innerHTML=""}}customElements.define(customElementsPrefix+"process-data-view",ProcessDataView);