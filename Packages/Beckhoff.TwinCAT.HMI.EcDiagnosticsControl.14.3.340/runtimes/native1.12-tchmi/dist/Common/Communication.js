import{NotificationLevel}from"./Notifications.js";import{extensionName}from"./Defines.js";import{ServerErrors}from"./ServerDefinitions.js";export class Communication{constructor(ecDiagnostics){this.__ecDiagnostics=ecDiagnostics}__ecDiagnostics;__subscriptionCallbacks=new Map;__pollingCallbacks=new Map;__unsubscribeInProgress=new Set;__unsubscribe(subscriptionId){this.__unsubscribeInProgress.add(subscriptionId)}__unsubscribedSuccessfully(subscriptionId){this.__unsubscribeInProgress.delete(subscriptionId),this.__subscriptionCallbacks.delete(subscriptionId)}unsubscribeAll(){for(const subscriptionId of this.__subscriptionCallbacks.keys())this.unsubscribe(subscriptionId)}__evaluateCommandError(command,cbErrorEl){const error=command.error,notification_error_key=command.symbol+"-message";if(!error)return this.__ecDiagnostics.notification.clearNotifications(notification_error_key),cbErrorEl?.button?.setStateToSuccess(),!1;TcHmi.Log.error(`The symbol '${command.symbol}' reports an error Code: ${error.code}, Message: ${error.message}, Reason: ${error.reason}`);let notificationLevel=NotificationLevel.error;const localization=this.__ecDiagnostics.getLocalization(),notification=cbErrorEl?.message??document.createElement("span");if(!cbErrorEl?.message){notification.classList.add("flex-col");const notificationServerReportsError=document.createElement("div");localization.addElement(notificationServerReportsError,"Server_Reports_Error"),notification.append(notificationServerReportsError)}const notificationError=document.createElement("div");switch(error.code){case ServerErrors.HMI_E_INVALID_DOMAIN:localization.addElement(notificationError,"Msg_Extension_Not_Loaded",[extensionName]);break;case ServerErrors.HMI_E_SYMBOL_NOT_MAPPED:localization.addElement(notificationError,"Msg_Symbol_Not_Mapped",[command.symbol]),notification.append(notificationError);break;case ServerErrors.HMI_E_INSUFFICIENT_ACCESS:localization.addElement(notificationError,"Msg_Unable_To_Access_Topology",[command.symbol]),notification.append(notificationError);break;default:if(error.code===ServerErrors.HMI_EC_DIAGNOSTICS_E_NOT_READY_YET&&(notificationLevel=NotificationLevel.warning),"Unsubscribe"===command.symbol)return;if(error.reason){const notificationErrorReason=document.createElement("div");localization.addElement(notificationErrorReason,"Server_Error_Reason",[error.reason]),notificationError.append(notificationErrorReason)}if(error.message){const notificationErrorMessage=document.createElement("div");localization.addElement(notificationErrorMessage,"Server_Error_Message",[error.message]),notificationError.append(notificationErrorMessage)}if(error.code){const notificationErrorCode=document.createElement("div");localization.addElement(notificationErrorCode,"Server_Error_Code",[error.code,error.code.toString(16)]),notificationError.append(notificationErrorCode)}}return notification.append(notificationError),cbErrorEl?(cbErrorEl.button?.setStateToError(),cbErrorEl.message?.classList.remove("hide")):this.__ecDiagnostics.notification.setNotification(notification,notificationLevel,notification_error_key),!0}processReadValues(callbacks,response){if(response.id&&this.__unsubscribeInProgress.has(response.id))return;if(callbacks.errorEl&&(callbacks.errorEl.message&&(callbacks.errorEl.message.textContent="",callbacks.errorEl.message.classList.add("hide")),callbacks.errorEl.button&&callbacks.errorEl.button.setStateToLoading()),response.error)return void TcHmi.Log.errorEx(`Server responded with error ${response.error.code.toString()}. Errordetail:`,response.error);const resultCommands=response.commands;if(!resultCommands||0===resultCommands.length)return void TcHmi.Log.error("Server did not respond with any commands.");let values=callbacks.cmdGroup?[]:null;for(const command of resultCommands){if(this.__evaluateCommandError(command,callbacks.errorEl)){if(callbacks.cmdGroup)continue;return}callbacks.cmdGroup?values.push({symbol:command.symbol,writeValue:command.writeValue,readValue:command.readValue}):values=command.readValue}return values}processReadValues_subscription(callbacks,response){const values=this.processReadValues(callbacks,response);void 0!==values&&(!callbacks.initialized&&callbacks.initCallback&&callbacks.initCallback(values),callbacks.tickCallback(values,!callbacks.initialized),callbacks.initialized=!0)}processReadValues_polling(callbacks,response){const values=this.processReadValues(callbacks,response);callbacks.tickCallback(values)}}