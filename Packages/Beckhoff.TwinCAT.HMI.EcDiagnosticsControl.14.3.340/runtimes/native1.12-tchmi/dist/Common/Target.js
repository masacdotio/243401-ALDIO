import{Master}from"./Master.js";import{extensionName}from"./Defines.js";import{TopologyView}from"./Topology.js";export class Target{constructor(main,netId,name,available,sysServiceAdsState){this.__main=main,this.__netId=netId,this.__name=name,this.__available=available,this.__sysServiceAdsState=sysServiceAdsState,this.__init()}__init(){this.__available?(this.__main.createNotification("target-available-now",{target:{netId:this.__netId,name:this.__name}}),this.__getMaster(),this.updateView()):this.__main.createNotification("target-not-available",{target:{netId:this.__netId,name:this.__name}})}getNetIdAndName(){return{netId:this.netId,name:this.name}}update(name,available,sysServiceAdsState,selectedDeviceChanged){let significantChange=selectedDeviceChanged;if(this.__sysServiceAdsState!==sysServiceAdsState){this.__sysServiceAdsState=sysServiceAdsState,significantChange=!0;for(const fn of this.__targetSysServiceAdsStateOnChangeFns)fn(this.__sysServiceAdsState)}this.__sysServiceAdsState=sysServiceAdsState,this.__name!==name&&(this.__name=name,significantChange=!0),this.__available!==available&&(this.__available=available,this.__available?(this.__main.createNotification("target-available-now",{target:{netId:this.__netId,name:this.__name}}),this.__getMaster()):(this.__main.createNotification("target-no-longer-available",{target:{netId:this.__netId,name:this.__name}}),this.__clearMasters())),significantChange&&this.__updateView("master")}updateView(master){this.__main.updateView(this,master)}displayView(){}__getMaster(){const comObj=this.__main.comObj;if(!comObj)return;this.__clearMasters();const subscriptionId=comObj.subscribe({symbol:`${extensionName}.GetMaster`,writeValue:this.__main.config.device},1e3,this.__updateMaster.bind(this),data=>{TcHmi.Log.info(`${extensionName}.GetMaster was subscribed successfully.`)});subscriptionId&&this.__subscriptions.set(`${extensionName}.GetMaster`,subscriptionId)}__clearMasters(){const comObj=this.__main.comObj;comObj&&(comObj.unsubscribe(this.__subscriptions.get(`${extensionName}.GetMaster`),()=>{this.__subscriptionInitialized=!1,this.__subscriptions.delete(`${extensionName}.GetMaster`),TcHmi.Log.info('Subscription "GetMasters" successfully unsubscribed.')}),this.__deleteAllMasters())}__subscriptions=new Map;__subscriptionInitialized=!1;__available;__sysServiceAdsState;get sysServiceAdsState(){return this.__sysServiceAdsState}__targetSysServiceAdsStateOnChangeFns=new Set;addTargetSysServiceAdsStateOnChangeFn(cb){this.__targetSysServiceAdsStateOnChangeFns.add(cb),cb(this.__sysServiceAdsState)}removeTargetSysServiceAdsStateOnChangeFn(cb){this.__targetSysServiceAdsStateOnChangeFns.delete(cb),cb(this.__sysServiceAdsState)}get comObj(){return this.main.comObj}__main;get main(){return this.__main}__netId;get netId(){return this.__netId}__name;get name(){return null===this.__name?"":this.__name}__masters=new Map;countMasters(){return this.__masters.size}__addMaster(masterNetId,masterName){this.__masters.set(masterNetId,new Master(this,masterNetId,masterName))}__deleteAllMasters(){for(const master of this.__masters.values())master.destroy();this.__masters.clear()}__updateMaster(data){this.__subscriptionInitialized=!0,this.__deleteAllMasters(),!1!==data&&void 0!==data&&(this.__addMaster(data.netId,data.name),this.__updateView("master"))}__updateView(type){const view=this.__main.view;if(view.name===TopologyView.None){if("master"===type){const selectedDevice=this.__main.getSelectedDevice();if(!selectedDevice)return;const master=this.__masters.get(selectedDevice.masterNetId);if(!master)return;this.__main.createNotification("master-found",{target:{name:this.__name,netId:this.__netId},master:{netId:master.netId,name:master.name}}),this.__main.setViewMaster(master),master.displayView()}}else TcHmi.Log.error(`Invalid name of view '${view.name}.'`)}setView(view,masterNetId=null){switch(view){case TopologyView.None:case TopologyView.Master:break;case TopologyView.Network:if(null===this.__available)return void this.__main.createNotification("waiting-for-target-availability",{target:{netId:this.__netId,name:this.__name}});if(null===masterNetId)return;if(!this.__subscriptionInitialized)return;const master=this.__masters.get(masterNetId);if(!master)return void this.__main.createNotification("master-not-found",{target:{netId:this.__netId,name:this.__name},master:{netId:masterNetId}});master.init_networkView();const msgData={target:{netId:this.netId,name:this.name},master:{netId:master.netId,name:master.name}};this.__main.setViewMaster(master),this.__main.createNotification("init-network-view",msgData);break;default:TcHmi.Log.error(`Invalid view for Target '${view}'`)}}destroy(){this.__main.comObj&&this.__clearMasters()}}