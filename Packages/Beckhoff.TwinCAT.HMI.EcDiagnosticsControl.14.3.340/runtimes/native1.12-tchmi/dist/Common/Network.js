import{PortMaster}from"./Port.js";import{Topology,TopologyType}from"./Topology.js";export class Network{constructor(master){this.__master=master;const contentWrapper=this.__master.main.contentWrapper,main=this.__master.main;this.__networkView=main.networkView,this.__networkView.init(master,this.drawMatrix),contentWrapper.append(this.__networkView),this.__resizeObserver=new ResizeObserver(entries=>{this.__resizeEvent()}),this.__resizeObserver.observe(contentWrapper),this.__updatePixelRatio()}__media;__updatePixelRatio=evt=>{this.__media=window.matchMedia(`(resolution: ${window.devicePixelRatio}dppx)`),this.__media.addEventListener("change",this.__updatePixelRatio,{once:!0}),evt&&this.__resizeEvent()};destroy(){this.__media?.removeEventListener("change",this.__updatePixelRatio),this.__networkView.deinit(),this.__resizeObserver.disconnect()}__resizeObserver;__master;get master(){return this.__master}get target(){return this.master.target}get main(){return this.target.main}reload(){this.__networkView.reload()}resetView(){this.__networkView.resetView()}update(slavesData){if(this.master.reset(),this.master.clearSlaves(),this.__hotConnectTopologies=[],this.__disabledSlaveTopologies=[],0!==slavesData.slavesCount&&slavesData.master.configuredSlave?this.__addMasterSlaveTopology(slavesData.master):this.__addMasterTopology(),slavesData.hotConnectGroups)for(const slaveData of slavesData.hotConnectGroups)this.__addHotConnectTopology(slaveData);if(slavesData.disabledSlaves)for(const slaveData of slavesData.disabledSlaves)this.__addDisabledSlave(slaveData);this.recalcNetwork()}get masterTopology(){return this.__master.topology}__hotConnectTopologies=[];getHotConnectTopologies(){return this.__hotConnectTopologies}__disabledSlaveTopologies=[];getDisabledSlaves(){return this.__disabledSlaveTopologies}__addMasterTopology(){this.__master.topology=new Topology(this,this.__master,TopologyType.master)}__addMasterSlaveTopology(slavesOfMaster){this.__addMasterTopology();const physic=slavesOfMaster.portPhysic;this.__master.setPort(1,new PortMaster(this.__master,1,physic,null,slavesOfMaster.configuredSlave))}__addHotConnectTopology(slave){const hotConnectTopoology=new Topology(this,slave,TopologyType.hotConnect);this.__hotConnectTopologies.push(hotConnectTopoology)}__addDisabledSlave(slave){const disabledSlaveTopology=new Topology(this,slave,TopologyType.disabled);this.__disabledSlaveTopologies.push(disabledSlaveTopology)}toggleExpansion(){for(const slave of this.master.slaves.values())slave.numOfOutgoingConfiguredCableLinkPorts>0&&(slave.expansion=!this.__isExpand);this.recalcNetwork(this.master)}__isExpand=!0;get isExpand(){return this.__isExpand}setToNotExpand(){this.__isExpand=!1}recalcNetwork(focusedComponent){if(!this.master.topology)return;const margin_x=0,margin_y=0;this.__isExpand=!0,this.master.topology.calcNetwork(),this.master.topology.calcMatrix(),this.__combinedMatrix.rows=[],this.__combinedMatrix.rows=this.__combinedMatrix.rows.concat(this.master.topology.matrixRows),this.__combinedMatrix.dimension={width:this.master.topology.matrixDimension.width,height:this.master.topology.matrixDimension.height},this.__combinedMatrix.componentOrder=[],this.__combinedMatrix.componentOrder=this.__combinedMatrix.componentOrder.concat(this.master.topology.componentOrder),this.__combinedMatrix.dimension.width+=margin_x,this.__combinedMatrix.dimension.height+=margin_y;let shift={x:0,y:0};for(const component of this.__combinedMatrix.componentOrder){const coordinates=component.coordinates;if(!coordinates){TcHmi.Log.error("Coordinates are not set yet");continue}const componentPos={x:coordinates.col,y:coordinates.row.yOffset};component===focusedComponent&&component.networkPos!==componentPos&&(shift={x:component.networkPos.x-componentPos.x,y:component.networkPos.y-componentPos.y}),component.networkPos=componentPos;for(const port of component.cableLinkPorts){const rel=port.pos.rel;port.pos.network={x:componentPos.x+rel.x,y:componentPos.y+rel.y}}}this.__networkView.calcZoomLevelLimits(),this.__drawMatrix(shift)}__resizeEvent(){this.__networkView.resizeEvent(()=>{this.drawMatrix()})}__networkView;__combinedMatrix={matrix:[],componentOrder:[],rows:[],dimension:{width:0,height:0}};drawMatrix=()=>{this.__drawMatrix()};__drawMatrix(shift){if(!this.__networkView)return void TcHmi.Log.error("Network view is not defined");if(this.__networkView.master!==this.master)return;const dimension=this.__combinedMatrix.dimension;this.__networkView.setInitialDimension(dimension),this.__networkView.initDrawing(),shift&&this.__networkView.shiftCanvasRelByZoomLevel(shift);const layers=this.__networkView.focusedLayers;layers.erase(),this.__networkView.clearCanvas();for(const component of this.__combinedMatrix.componentOrder)this.__networkView.drawComponent(component,layers);this.master.topology&&this.__networkView.updateHover()}}