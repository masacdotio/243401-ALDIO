import{Notifications,NotificationCategory,NotificationLevel}from"./Notifications.js";import{Target}from"./Target.js";import{TopologyView}from"./Topology.js";import{DrawingNetwork}from"./DrawingNetwork.js";import"./WebComponents/PopUp/PopUp.js";import{customElementsPrefix,extensionName}from"./Defines.js";import{SymbolAccess}from"./ServerDefinitions.js";export class EcDiagnostics{constructor(elementRoot,localization,commonPath,config,customTopMostLayerFns){elementRoot.classList.add("beckhoff-ec-diagnostics"),this.__elementRoot=elementRoot,this.__localization=localization,this.__localConfig=config,this.__contentWrapper=this.__elementRoot,customTopMostLayerFns&&this.setCustomTopMostLayerFunction(customTopMostLayerFns.add,customTopMostLayerFns.remove),this.__notification=new Notifications(this.__elementRoot),this.__commonPath=commonPath,this.__networkView=new DrawingNetwork(this),this.__contentWrapper.append(this.__networkView)}__networkView;get networkView(){return this.__networkView}__commonPath;get commonPath(){return this.__commonPath}__localization;getLocalization(){return this.__localization}setCustomTopMostLayerFunction(addFn,removeFn){this.__customAddTopMostLayerFunction=addFn,this.__customRemoveTopMostLayerFunction=removeFn}__customAddTopMostLayerFunction=null;__customRemoveTopMostLayerFunction=null;setThemedResource(){}clearAllNotifications(){this.__notification.clearAllNotifications()}get notification(){return this.__notification}clearNotification(category,level){this.__notification.clearNotifications(category,level)}setNotification(text,level,category,displayTime){this.__notification.setNotification(text,level,category,displayTime)}createNotification(key,params){this.__notification.create(key,this.__localization,params)}static createElement(tagName,options){return document.createElement(tagName,options)}createStatusButton(text){const button=EcDiagnostics.createElement(customElementsPrefix+"status-button");return button.init(this,text),button}__targets=new Map;__selectedDevice=null;getSelectedDevice(){return this.__selectedDevice}__notification;__localConfig;get config(){return this.__localConfig}__view={name:TopologyView.None};__elementRoot;getElementRoot(){return this.__elementRoot}__comObj=null;set comObj(comObj){this.__comObj=comObj}get comObj(){return this.__comObj}displayView(){}get view(){return this.__view}updateConfigDevice(device,executeInitOnSuccess){this.__localConfig.device=device,this.__initialized&&this.preInit(executeInitOnSuccess)}updateConfigAllowZoomAndPan(allowZoomAndPan,executeInitOnSuccess){this.__localConfig.allowZoomAndPan=allowZoomAndPan,this.__initialized&&this.preInit(executeInitOnSuccess)}updateConfigToolboxResetView(toolboxResetView,executeInitOnSuccess){this.__localConfig.toolboxResetView=toolboxResetView,this.__initialized&&this.preInit(executeInitOnSuccess)}updateConfigExperimentalMode(experimental,executeInitOnSuccess){this.__localConfig.experimentalMode=experimental,this.__initialized&&this.preInit(executeInitOnSuccess)}updateConfigInitTopology(initTopology,executeInitOnSuccess){this.__localConfig.initTopologyViewPosX=initTopology.pos.x,this.__localConfig.initTopologyViewPosY=initTopology.pos.y,this.__localConfig.initTopologyViewZoom=initTopology.zoom,this.__initialized&&this.preInit(executeInitOnSuccess)}__configDevicesSubscription=null;__targetSubscription=null;__initialized=!1;preInit(executeInitOnSuccess=!1){if(this.cleanUp(),this.__comObj){if(this.__initialized=!0,executeInitOnSuccess)if(this.__localConfig.device)if(executeInitOnSuccess)this.__notification.clearNotifications(NotificationCategory.task),this.__configDevicesSubscription=this.__comObj.subscribe({symbol:`${extensionName}.ListConfiguredDevices`},1e3,devices=>{if(this.__localConfig.device)if(this.__comObj){if(devices&&this.__localConfig.device in devices)this.__notification.clearNotifications(NotificationCategory.task),this.__configDevicesSubscription&&this.__comObj.unsubscribe(this.__configDevicesSubscription);else{const notificationEl=document.createElement("div");notificationEl.classList.add("flex-col");const msgElDeviceNotConfigured=document.createElement("span");if(this.__localization.addElement(msgElDeviceNotConfigured,"Msg_Device_Not_Configured",[this.__localConfig.device]),notificationEl.append(msgElDeviceNotConfigured),devices&&Object.keys(devices).length>0){const msgElDeviceList=document.createElement("div"),deviceList=document.createElement("ul");for(const[deviceName,deviceConfig]of Object.entries(devices)){const device=this.__localization.createLocalizedElement(`${deviceName} ({{Enabled}}: ${deviceConfig.enabled}, {{Target}}: ${deviceConfig.targetNetId}, {{Master}}: ${deviceConfig.masterNetId})`,"li");deviceList.append(device)}this.__localization.addElement(msgElDeviceList,"Msg_Device_List",[deviceList]),notificationEl.append(msgElDeviceList)}else{const msgElNoDeviceConfigured=document.createElement("div");this.__localization.addElement(msgElNoDeviceConfigured,"Msg_No_Device_Configured"),notificationEl.append(msgElNoDeviceConfigured)}this.__notification.setNotification(notificationEl,executeInitOnSuccess?NotificationLevel.error:NotificationLevel.info,NotificationCategory.task)}this.__checkSymbolAccess(this.init.bind(this))}else TcHmi.Log.error("Please initialize WebSocket Object first.");else TcHmi.Log.error("Device attribute is not defined.")});else{const notification=this.__localization.createLocalizedElement(`{{Device}}: ${this.__localConfig.device}`);this.__notification.setNotification(notification,NotificationLevel.info,NotificationCategory.task)}else this.__configDevicesSubscription=this.__comObj.subscribe({symbol:`${extensionName}.ListConfiguredDevices`},1e3,devices=>{const notificationEl=document.createElement("div");notificationEl.classList.add("flex-col");const msgElDeviceAttributeNotSet=document.createElement("span");if(this.__localization.addElement(msgElDeviceAttributeNotSet,"Msg_Device_Attribute_Is_Not_Set"),notificationEl.append(msgElDeviceAttributeNotSet),devices&&Object.keys(devices).length>0){const msgElDeviceList=document.createElement("div"),deviceList=document.createElement("ul");for(const[deviceName,deviceConfig]of Object.entries(devices)){const device=document.createElement("li");device.textContent=`${deviceName} (Enabled: ${deviceConfig.enabled}, Target: ${deviceConfig.targetNetId}, Master: ${deviceConfig.masterNetId})`,deviceList.append(device)}this.__localization.addElement(msgElDeviceList,"Msg_Device_List",[deviceList]),notificationEl.append(msgElDeviceList)}else{const msgElNoDeviceConfigured=document.createElement("div");this.__localization.addElement(msgElNoDeviceConfigured,"Msg_No_Device_Configured"),notificationEl.append(msgElNoDeviceConfigured)}this.__notification.setNotification(notificationEl,executeInitOnSuccess?NotificationLevel.error:NotificationLevel.info,NotificationCategory.task)})}else TcHmi.Log.error("Please initialize WebSocket Object first.")}init(){this.__comObj?(this.cleanUp(!0),this.__targetSubscription=this.__comObj.subscribe({symbol:`${extensionName}.GetTarget`,writeValue:this.__localConfig.device},1e3,this.__updateTarget.bind(this),data=>{TcHmi.Log.info(`${extensionName}.GetTarget was subscribed successfully.`)})):TcHmi.Log.error("Please initialize WebSocket Object first.")}__symbolAccess=new Map;getSymbolAccess(symbol){return this.__symbolAccess.get(symbol)??!1}__symbolAccessSubscription=null;__checkSymbolAccess(callback){if(!this.__comObj)return void TcHmi.Log.error("Please initialize WebSocket Object first.");const symbols=[`${extensionName}.ListConfiguredDevices`,`${extensionName}.Config`,`${extensionName}.GetTarget`,`${extensionName}.GetMaster`,`${extensionName}.GetSlaves`,`${extensionName}.GetMasterOnlineInfo`,`${extensionName}.GetSlavesOnlineInfo`,`${extensionName}.GetSlavesScanned`,`${extensionName}.SendSlavesScanCmd`,`${extensionName}.SetProcessDataValues`,`${extensionName}.ForceProcessDataValues`,`${extensionName}.ReleaseProcessDataValues`,`${extensionName}.SetMasterStateMachine`],cmds=[];for(const symbol of symbols)cmds.push({symbol:"GetSymbolAccess",writeValue:symbol});this.__comObj.subscribe(cmds,1e3,(values,firstTick)=>{for(const value of values)"GetSymbolAccess"===value.symbol&&this.__symbolAccess.set(value.writeValue,value.readValue===SymbolAccess.ReadWrite);callback();const notificationEl=document.createElement("span"),localization=this.getLocalization();firstTick||(this.notification.clearAllNotifications(),localization.addElement(notificationEl,"Msg_Change_Of_User_Rights"),this.notification.setNotification(notificationEl,NotificationLevel.success,NotificationCategory.ws,3e3))})}destroy(){this.__networkView.destroy(),this.__localization.destroy(),this.cleanUp()}cleanUp(cleanOnlyFromInit=!1){if(this.__comObj){cleanOnlyFromInit||this.__configDevicesSubscription&&this.__comObj.unsubscribe(this.__configDevicesSubscription),null!==this.__targetSubscription&&(this.__comObj.unsubscribe(this.__targetSubscription),this.__targetSubscription=null),this.__comObj.unsubscribe(this.__symbolAccessSubscription);for(const target of this.__targets.values())target.destroy();this.__targets.clear()}else TcHmi.Log.error("Please initialize WebSocket Object first.")}__updateTarget(targetData){if(targetData){const selectedDeviceChanged=this.__selectedDevice?.targetNetId!==targetData.netId||this.__selectedDevice?.masterNetId!==targetData.config.masterNetId;selectedDeviceChanged&&(this.__selectedDevice={targetNetId:targetData.netId,masterNetId:targetData.config.masterNetId}),this.__addOrUpdateTarget(targetData.netId,targetData.name,targetData.available,targetData.sysServiceAdsState,selectedDeviceChanged)}else{if(!this.__selectedDevice)return;const targetToRemove=this.__targets.get(this.__selectedDevice.targetNetId);targetToRemove&&(targetToRemove.destroy(),this.__targets.delete(this.__selectedDevice.targetNetId))}}setViewMaster(master){this.__view.master=master}updateView(target,master){if(this.__view.name===TopologyView.None&&this.__view.target===target)if(this.__selectedDevice?.masterNetId){if(!master)return;master.netId===this.__selectedDevice.masterNetId&&(master.displayView(),this.__view.master=master)}else target.displayView()}reload(){this.__view.master?.reload()}resetView(){this.__view.master?.resetView()}setView(view,target,masterNetId){switch(view){case TopologyView.None:case TopologyView.Target:break;case TopologyView.Master:if(!target)return;target.setView(TopologyView.Master);break;case TopologyView.Network:if(!target)return;target.setView(TopologyView.Network,masterNetId);break;default:TcHmi.Log.error(`Invalid view '${view}' for EcDiagnostics.`)}}__clearTargets(){for(const target of this.__targets.values())target.destroy()}__addOrUpdateTarget(targetNetId,targetName,available,sysServiceAdsState,selectedDeviceChanged){const existingTarget=this.__targets.get(targetNetId);if(existingTarget)existingTarget.update(targetName,available,sysServiceAdsState,selectedDeviceChanged);else{const newTarget=new Target(this,targetNetId,targetName,available,sysServiceAdsState);this.__targets.set(targetNetId,newTarget),this.__view.target=newTarget}}__templates=new Map;loadTemplates(){return fetch(`${this.__commonPath}/Templates/PopUp.html`).then(response=>response.ok?response.text():Promise.reject(new Error)).then(data=>{const tempDiv=document.createElement("div");tempDiv.innerHTML=data,this.__localization.addAllLocalizedElements(tempDiv);const templateElements=tempDiv.querySelectorAll("[template]");for(const templateElement of templateElements){const templateName=templateElement.getAttribute("template");templateName?(this.__templates.set(templateName,templateElement),templateElement.remove()):TcHmi.Log.warn("Template has no name.")}})}getTemplate(name){const template=this.__templates.get(name);return template?template.cloneNode(!0):null}__contentWrapper;get contentWrapper(){return this.__contentWrapper}addTopMostLayer(element){if(this.__customAddTopMostLayerFunction){this.__customAddTopMostLayerFunction(element);const parent=element.parentElement;parent&&parent.classList.add("beckhoff-ec-diagnostics"),element.addFnToCallOnRemove(()=>{this.__customRemoveTopMostLayerFunction&&this.__customRemoveTopMostLayerFunction(element)})}else{let topMostLayerWrapper=document.querySelector(`${customElementsPrefix}topmostlayer-wrapper`);topMostLayerWrapper||(topMostLayerWrapper=document.createElement(`${customElementsPrefix}topmostlayer-wrapper`),topMostLayerWrapper.classList.add("beckhoff-ec-diagnostics"),document.body.append(topMostLayerWrapper)),topMostLayerWrapper.append(element)}}addPopUp(popup){this.addTopMostLayer(popup)}}