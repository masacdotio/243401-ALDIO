import*as Vector from"./Vector.js";import{Drawing,getGlobalOffset}from"./Drawing.js";import{LayerName}from"./Layer.js";import{store}from"./Appearance.js";export var WheelDeltaMode;!function(WheelDeltaMode){WheelDeltaMode[WheelDeltaMode.DOM_DELTA_PIXEL=0]="DOM_DELTA_PIXEL",WheelDeltaMode[WheelDeltaMode.DOM_DELTA_LINE=1]="DOM_DELTA_LINE",WheelDeltaMode[WheelDeltaMode.DOM_DELTA_PAGE=2]="DOM_DELTA_PAGE"}(WheelDeltaMode||(WheelDeltaMode={}));export class DrawingInteraction extends Drawing{constructor(main,master,view,dimension,redrawFn,manualInit=!1){super(main,master,view,dimension),this.__redrawFn=redrawFn,manualInit||this.__addEvents()}__addEvents(){this.addEventListener("dragstart",()=>!1),this.addEventListener("click",this.__handleClick),this.addEventListener("pointerup",this.__handlePointerUp),this.addEventListener("pointerdown",this.__handlePointerDown),this.addEventListener("pointermove",this.__handlePointerMove),this.addEventListener("pointercancel",this.__handlePointerUp),this.addEventListener("pointerleave",this.__handlePointerUp),this.addEventListener("contextmenu",this.__handleContextMenu),this.addEventListener("pointerover",this.__handlePointerOver),this.addEventListener("pointerout",this.__handlePointerOut)}__removeEvents(){this.removeEventListener("click",this.__handleClick),this.removeEventListener("pointerup",this.__handlePointerUp),this.removeEventListener("pointerdown",this.__handlePointerDown),this.removeEventListener("pointermove",this.__handlePointerMove),this.removeEventListener("pointercancel",this.__handlePointerUp),this.removeEventListener("pointerleave",this.__handlePointerUp),this.removeEventListener("contextmenu",this.__handleContextMenu),this.removeEventListener("pointerover",this.__handlePointerOver),this.removeEventListener("pointerout",this.__handlePointerOut),this.removeEventListener("wheel",this.__handleWheel)}__init(){this.__focusedLayers.reset(),this.__addEvents(),this.addZoomAndPan()}__deinit(){this.__focusedLayers.reset(),this.__removeEvents(),this.removeZoomAndPan()}__redrawFn;__pointerIsOver=!1;__userInteracted=!1;__zoomAndPan=!1;destroy(){this.__removeEvents(),this.remove(),super.destroy()}__activePointers=new Map;reload(){this.__redrawFn&&this.__redrawFn()}update(){super.update()}resetView(initTopologyViewPosX,initTopologyViewPosY,initTopologyViewZoom){this.setZoomLevel(initTopologyViewZoom,!1),this.__shiftCanvas({x:initTopologyViewPosX,y:initTopologyViewPosY}),this.__focusedLayers.setFocusedZoom(this.__zoomLevel),this.__focusedLayers.erase(),this.reload(),this.__userInteracted=!1}resizeEvent(callback){this.__focusedLayers.resizeEvent(),callback()}__handlePointerOver=e=>{this.__pointerIsOver=!0};__handlePointerOut=e=>{this.__pointerIsOver=!1,this.__handlePointerUp(e),this.__handleHover(e)};__handlePointerDown=e=>{0===e.button&&(0===this.__activePointers.size&&(this.__obeyClick=!0,this.__pointerPos.down={x:e.clientX,y:e.clientY},this.__pointerPos.move={x:e.clientX,y:e.clientY}),this.__zoomAndPan&&this.__main.config.allowZoomAndPan&&(this.style.cursor="move"),this.__activePointers.set(e.pointerId,e))};updateHover(e){this.__handleHover(e??null)}__handlePointerMove=e=>{switch(this.__activePointers.size){case 0:this.__handlePointerUpMove(e);break;case 1:if(!this.__zoomAndPan)break;this.__main.config.allowZoomAndPan&&e.isPrimary&&(this.__handlePan(e),this.__pointerPos.move={x:e.clientX,y:e.clientY});break;case 2:if(this.__zoomAndPan&&this.__main.config.allowZoomAndPan){this.__obeyClick=!1;let movedPointer=null,staticPointer=null;for(const[activePointerId,activePointerEvent]of this.__activePointers)e.pointerId===activePointerId?movedPointer={x:activePointerEvent.clientX,y:activePointerEvent.clientY}:staticPointer={x:activePointerEvent.clientX,y:activePointerEvent.clientY};if(movedPointer&&staticPointer){const oldDistance=Vector.getVectorLength(movedPointer,staticPointer),modification=Vector.getVectorLength({x:e.clientX,y:e.clientY},staticPointer)-oldDistance,zoomPos=Vector.getCenter({x:e.clientX,y:e.clientY},staticPointer);this.__applyZoom(zoomPos,modification/200)}else TcHmi.Log.error("Moved pointer or static pointer does not exist.")}}this.__activePointers.has(e.pointerId)&&this.__activePointers.set(e.pointerId,e)};__handlePointerUp=e=>{this.__activePointers.delete(e.pointerId),0===this.__activePointers.size&&(this.__pointerPos.down=null,this.__pointerPos.move=null,this.style.cursor="default")};__handlePointerUpMove=e=>{this.__handleHover(e)};__handleHover(e){if(!store.appearance)return void TcHmi.Log.error("Appearance is null.");const tooltip=this.__tooltip,ctx=this.__focusedLayers.getContext(LayerName.hover);if(this.__focusedLayers.erase(LayerName.hover),tooltip.hide(),this.__pointerIsOver){if(e){const target={x:e.clientX,y:e.clientY};this.__pointerPos.hover={x:target.x,y:target.y}}else if(!this.__pointerPos.hover)return;if(!this.__pointerPos.down){const eventTarget=this.__findTargetByPosition(this.__pointerPos.hover);if(eventTarget){ctx.strokeStyle=store.appearance.hover.border.color.getRGBAString(),ctx.lineWidth=store.appearance.hover.border.width,ctx.strokeRect(eventTarget.x,eventTarget.y,eventTarget.w,eventTarget.h);const localization=this.__main.getLocalization();if(eventTarget.hoverText){const localizedHoverTextElement=localization.createLocalizedElement(eventTarget.hoverText,"span");tooltip.show(localizedHoverTextElement,this.__pointerPos.hover.x,this.__pointerPos.hover.y)}this.__pointerPos.move||(void 0===eventTarget.primaryPointerFn?this.style.cursor="default":this.style.cursor="pointer")}else this.__pointerPos.move||(this.style.cursor="default")}}}__handlePan=e=>{if(!this.__zoomAndPan)return;if(!this.__pointerPos.down||!this.__pointerPos.move)return;this.__userInteracted=!0;const currentPos_x=e.clientX,currentPos_y=e.clientY,cssScaling=this.getCssScaling(),movement={x:(currentPos_x-this.__pointerPos.move.x)*window.devicePixelRatio/cssScaling.x,y:(currentPos_y-this.__pointerPos.move.y)*window.devicePixelRatio/cssScaling.y};this.style.cursor="move",this.shiftCanvasRel({x:movement.x,y:movement.y}),this.__redrawFn&&this.__redrawFn(),this.__showUpdatedViewInfo();const movementSincePointerDown_x=Math.abs(currentPos_x-this.__pointerPos.down.x)*window.devicePixelRatio/cssScaling.x,movementSincePointerDown_y=Math.abs(currentPos_y-this.__pointerPos.down.y)*window.devicePixelRatio/cssScaling.y;(movementSincePointerDown_x>10||movementSincePointerDown_y>10)&&(this.__obeyClick=!1)};__handleWheel=wheelEvent=>{if(wheelEvent.preventDefault(),!this.__redrawFn)return;this.__userInteracted=!0;let zoomModification=-wheelEvent.deltaY/2e3;wheelEvent.deltaMode===WheelDeltaMode.DOM_DELTA_LINE&&(zoomModification=-wheelEvent.deltaY/2e3*33);const zoomPos={x:wheelEvent.clientX*window.devicePixelRatio,y:wheelEvent.clientY*window.devicePixelRatio};this.__applyZoom(zoomPos,zoomModification)};shiftCanvasRelByZoomLevel(modification){const unzoomedModification_x=modification.x*this.__zoomLevel,unzoomedModification_y=modification.y*this.__zoomLevel;this.__shiftCanvas({x:this.__shift.x+unzoomedModification_x,y:this.__shift.y+unzoomedModification_y})}shiftCanvasRel(modification){this.__shiftCanvas({x:this.__shift.x+modification.x,y:this.__shift.y+modification.y})}__shiftCanvas(newShift){this.__shift=newShift,this.__focusedLayers.setFocusedShift(this.__shift)}addZoomAndPan(){this.__zoomAndPan=!0,this.__main.config.allowZoomAndPan&&this.addEventListener("wheel",this.__handleWheel)}removeZoomAndPan(){this.__zoomAndPan=!1,this.removeEventListener("wheel",this.__handleWheel)}preDrawingEvent(){if(!this.__userInteracted){this.calcZoomLevelLimits();const config=this.__main.config;this.__shiftCanvas({x:config.initTopologyViewPosX,y:config.initTopologyViewPosY}),config.initTopologyViewZoom?this.setZoomLevel(config.initTopologyViewZoom,!1):this.setZoomLevel(null)}}__calcZoomPositionCorrection(zoomPos,relativeZoomLevel){this.__userInteracted=!0;const frameOffset=getGlobalOffset(this),cssScaling=this.getCssScaling(),spacings_x=(zoomPos.x-frameOffset.left)/cssScaling.x-this.__shift.x,spacings_y=(zoomPos.y-frameOffset.top)/cssScaling.y-this.__shift.y;return{x:-spacings_x*((relativeZoomLevel=this.__zoomLevel/(this.__zoomLevel-relativeZoomLevel))-1),y:-spacings_y*(relativeZoomLevel-1)}}__applyZoom(position,modification){const appliedZoomModification=this.addZoomLevel(modification),relShift=this.__calcZoomPositionCorrection(position,appliedZoomModification);this.shiftCanvasRel(relShift),this.__focusedLayers.setFocusedZoom(this.__zoomLevel),this.__focusedLayers.erase(),this.__redrawFn&&this.__redrawFn()}calcZoomLevelLimits(){const parentElement=this.parentElement;if(!parentElement)return;const minWidthZoomLevel=parentElement.offsetWidth/this.__dimension.initial.width,minHeightZoomLevel=parentElement.offsetHeight/this.__dimension.initial.height;this.__zoomLevelLimits.min=minWidthZoomLevel<minHeightZoomLevel?minWidthZoomLevel:minHeightZoomLevel;const maxWidthZoomLevel=parentElement.offsetWidth/100,maxHeightZoomLevel=parentElement.offsetHeight/400;this.__zoomLevelLimits.max=maxWidthZoomLevel<maxHeightZoomLevel?maxWidthZoomLevel:maxHeightZoomLevel}}