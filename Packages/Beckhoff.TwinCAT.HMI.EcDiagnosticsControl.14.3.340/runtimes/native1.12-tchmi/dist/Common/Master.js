import{Network}from"./Network.js";import{Component,StateMachineStateName}from"./Component.js";import{extensionName}from"./Defines.js";import{SyncUnits}from"./SyncUnits.js";import{setOnlineData}from"./DOMUtility.js";import{compareObjects}from"./Utility.js";import{NotificationCategory}from"./Notifications.js";export class Master extends Component{constructor(target,netId,name){super(target.countMasters()),this.__target=target,this.__netId=netId,this.__name=name,this.__data={online:{stateMachine:{code:{value:null,domElements:new Set},name:{value:null,domElements:new Set}},stateMachineRequested:{code:{value:null,domElements:new Set},name:{value:null,domElements:new Set}},frames:{total:{cyclic:{value:null,domElements:new Set},acyclic:{value:null,domElements:new Set}},perSec:{cyclic:{value:null,domElements:new Set},acyclic:{value:null,domElements:new Set}},missed:{cyclic:{value:null,domElements:new Set},acyclic:{value:null,domElements:new Set}},damaged:{sent:{value:null,domElements:new Set},received:{value:null,domElements:new Set}}}}},this.__masterWriteValue=this.main.config.device,this.__calculateDesign(),this.__network=new Network(this);this.__pos={coordinates:{col:0,row:{index:0,yOffset:0,width:0,height:0}},network:{x:-1,y:-1}};const comObj=this.main.comObj;comObj&&this.__subscriptions.set(`${extensionName}.GetMasterOnlineInfo`,comObj.subscribe({symbol:`${extensionName}.GetMasterOnlineInfo`,writeValue:this.__masterWriteValue},1e3,this.updateMasterOnlineInfo.bind(this),()=>{TcHmi.Log.info(`${extensionName}.GetMasterOnlineInfo was subscribed successfully.`)}))}reload(){this.__network.reload()}resetView(){this.__network.resetView()}getNetIdAndName(){return{netId:this.netId,name:this.name}}getTargetAndMasterNetIdAndName(){return{target:this.__target.getNetIdAndName(),master:this.getNetIdAndName()}}set startCoordinates(coordinates){this.__pos.coordinates=coordinates}get coordinates(){return this.__pos.coordinates}set networkPos(value){this.__pos.network=value}get networkPos(){return this.__pos.network}follow(){if(null===this.topology)return;this.topology.componentOrder.push(this);const outPort=this.__ports[1];if(!outPort)return;const nextTrace=outPort.nextTrace;if(!nextTrace)return;const coordinates={col:this.__pos.coordinates.col,row:this.__pos.coordinates.row};coordinates.col+=this.__design.dimension.width,outPort.isCableLink&&(coordinates.col+=200),nextTrace.pos=coordinates,outPort.nextSlave?.follow(0)}__pos;get pos(){return this.__pos}__topology=null;get topology(){return this.__topology}set topology(value){this.__topology=value}__network;get network(){return this.__network}__trace=null;get trace(){return this.__trace}__subscriptions=new Map;get main(){return this.__target.main}displayView(){this.init_networkView(),this.main.createNotification("init-network-view",this.getTargetAndMasterNetIdAndName())}hideView(){}init_networkView(){this.__deleteOldSlaveSubscriptions();const comObj=this.main.comObj;comObj&&this.__subscriptions.set(`${extensionName}.GetSlaves`,comObj.subscribe({symbol:`${extensionName}.GetSlaves`,writeValue:this.__masterWriteValue},1e3,this.__updateSlaves.bind(this),()=>{TcHmi.Log.info(`${extensionName}.GetSlaves was subscribed successfully.`),this.__subscriptions.set(`${extensionName}.GetSlavesOnlineInfo`,comObj.subscribe({symbol:`${extensionName}.GetSlavesOnlineInfo`,writeValue:this.__masterWriteValue},500,this.updateSlavesOnlineInfo.bind(this),()=>{TcHmi.Log.info(`${extensionName}.GetSlavesOnlineInfo was subscribed successfully.`)})),this.__subscriptions.set(`${extensionName}.GetSlavesScanned`,comObj.subscribe({symbol:`${extensionName}.GetSlavesScanned`,writeValue:this.__masterWriteValue},2e3,this.updateSlavesScanned.bind(this),()=>{TcHmi.Log.info(`${extensionName}.GetSlavesScanned was subscribed successfully.`)})),this.__subscriptions.set(`${extensionName}.ListSlavesWithForcedProcessData`,comObj.subscribe({symbol:`${extensionName}.ListSlavesWithForcedProcessData`,writeValue:this.__masterWriteValue},1e3,this.updateSlavesWithForcedProcessData.bind(this),()=>{TcHmi.Log.info(`${extensionName}.ListSlavesWithForcedProcessData was subscribed successfully.`)}))}))}__deleteOldSlaveSubscriptions(){this.__removeSubscription(`${extensionName}.GetSlaves`),this.__removeSubscription(`${extensionName}.GetSlavesOnlineInfo`),this.__removeSubscription(`${extensionName}.GetSlavesScanned`),this.__removeSubscription(`${extensionName}.ListSlavesWithForcedProcessData`)}__syncUnits=new SyncUnits;get syncUnits(){return this.__syncUnits}__clearSyncUnits(){this.__syncUnits.clear()}addSlaveToSyncUnit(slave){const syncUnitIdsOfSlave=slave.syncUnitIds;if(syncUnitIdsOfSlave)for(const id of syncUnitIdsOfSlave)this.__syncUnits.addSlave(id,slave)}__selectedSyncUnit=null;set selectedSyncUnit(syncUnitId){this.__selectedSyncUnit=syncUnitId}get selectedSyncUnit(){return this.__selectedSyncUnit}__target;get target(){return this.__target}get netId(){return this.__netId}__name;get name(){return this.__name}get master(){return this}__data;get data(){return this.__data}__masterWriteValue=null;__slaves=new Map;__numOfSlaves=0;getSlave(addr){return this.__slaves.get(addr)}addSlave(slave){this.addSlaveToSyncUnit(slave),this.__numOfSlaves++,this.__slaves.set(slave.addr,slave)}get slaves(){return this.__slaves}__slavesSorted=[];addSortedSlave(slave){this.__slavesSorted.push(slave)}clearSlaves(){this.__numOfSlaves=0,this.__slaves.clear()}get numOfSlaves(){return this.__numOfSlaves}__slavesScanned=null;get slavesScanned(){return this.__slavesScanned}__slavesScanInProgress=!1;get isSlavesScanInProgress(){return this.__slavesScanInProgress}set slavesScanInProgress(value){this.__slavesScanInProgress=value}__extendedInfoOfMaster=null;__extendedInfoOfSlave=null;__extendedInfoTabName={Slave:null,Master:null};setExtendedInfoTabName(component,tabName){void 0!==this.__extendedInfoTabName[component]?this.__extendedInfoTabName[component]=tabName:TcHmi.Log.error(`There is no known component called ${component}`)}getExtendedInfoTabName(component){return void 0!==this.__extendedInfoTabName[component]?this.__extendedInfoTabName[component]:(TcHmi.Log.error(`There is no known component called ${component}`),null)}getExtendedInfoOfMaster(){return this.__extendedInfoOfMaster}getExtendedInfoOfSlave(){return this.__extendedInfoOfSlave}setExtendedInfoOfMaster(extendedInfo){const oldExtendedInfo=this.__extendedInfoOfMaster;this.__extendedInfoOfMaster=extendedInfo,oldExtendedInfo&&oldExtendedInfo.close()}setExtendedInfoOfSlave(extendedInfo){const oldExtendedInfo=this.__extendedInfoOfSlave;if(this.__extendedInfoOfSlave=extendedInfo,oldExtendedInfo){const scrollTop=oldExtendedInfo?.getScrollTop();scrollTop&&this.__extendedInfoOfSlave.setScrollTop(scrollTop),oldExtendedInfo.close()}}removeExtendedInfoOfMaster(extendedInfo){this.__extendedInfoOfMaster===extendedInfo&&(this.__extendedInfoOfMaster=null)}removeExtendedInfoOfSlave(extendedInfo){this.__extendedInfoOfSlave===extendedInfo&&(this.__extendedInfoOfSlave=null)}__netId;__ports=[];get ports(){return this.__ports}setPort(index,port){this.__ports[index]=port}checkPresence(){}get isPresent(){return!0}checkPortState(){}checkIdentity(){}__state=null;set state(state){this.__state=state}__design={dimension:{width:500,height:400},color:{r:249,g:249,b:249},labelColor:"#000",labelHeight:0,interior:{offset:{x:0,y:0},dimension:{width:100,height:300},section:{cols:1,rows:4}}};__calculateDesign(){this.__design.interior.offset.x=this.__design.dimension.width-100,this.__design.interior.dimension.height=this.__design.dimension.height-100}__subscriptionReadValues=new Map;__subscriptionOldReadValues=new Map;__removeSubscriptions(){this.__removeSubscription(`${extensionName}.GetMasterOnlineInfo`),this.__removeSubscription(`${extensionName}.GetSlaves`),this.__removeSubscription(`${extensionName}.GetSlavesOnlineInfo`),this.__removeSubscription(`${extensionName}.GetSlavesScanned`),this.__removeSubscription(`${extensionName}.ListSlavesWithForcedProcessData`)}__removeSubscription(symbol){this.main.comObj?.unsubscribe(this.__subscriptions.get(symbol)),this.__subscriptions.delete(symbol);const symbolWithoutExtensionName=symbol.slice(extensionName.length);symbolWithoutExtensionName in this.__subscriptionOldReadValues&&this.__subscriptionOldReadValues.delete(symbolWithoutExtensionName)}destroy(){this.__removeSubscriptions(),this.__extendedInfoOfMaster?.close(),this.__extendedInfoOfSlave?.close(),this.__network.destroy()}hide(){}__updateSlaves(data){data&&this.configDetailsValid(data.config)&&(this.__slaves.clear(),this.__slavesSorted=[],this.__syncUnits=new SyncUnits,this.__extendedInfoOfSlave?.close(),this.__extendedInfoOfSlave=null,this.__extendedInfoOfMaster?.close(),this.__extendedInfoOfMaster=null,this.__network.update(data),0!==data.slavesCount&&this.updateSlavesOnlineInfo(null),this.main.clearNotification(NotificationCategory.task),this.__subscriptionReadValues.set("GetSlaves",data))}updateMasterOnlineInfo(data){let significantChangeToRedraw=!1;if(void 0===data)return;if(null!==data&&!this.configDetailsValid(data.config))return;const symbol="GetMasterOnlineInfo";if(data?this.__subscriptionReadValues.set(symbol,data):this.__subscriptionOldReadValues.set(symbol,{}),!this.__subscriptionReadValues.has(symbol))return;this.__subscriptionOldReadValues.has(symbol)||this.__subscriptionOldReadValues.set(symbol,{});const changes=compareObjects(this.__subscriptionOldReadValues.get(symbol),this.__subscriptionReadValues.get(symbol));significantChangeToRedraw||="stateMachine"in changes,this.processOnlineChanges(changes),Object.assign(this.__subscriptionOldReadValues.get(symbol)??{},this.__subscriptionReadValues.get(symbol)),significantChangeToRedraw&&this.network.drawMatrix()}updateSlavesScanned(data){if(this.slavesScanInProgress=!1,!1===data)return;if(!this.configDetailsValid(data.config))return;this.__slavesScanned=data;let scannedSlaveIndex=0;for(const slave of this.__slavesSorted){if(!slave||slave.isDisabled||slave.isNotPresent){slave.processScannedIdentity(null);continue}const slaveScanned=this.__slavesScanned.slaves[scannedSlaveIndex];if(!slaveScanned){slave.processScannedIdentity(null);break}scannedSlaveIndex++,slave.processScannedIdentity(slaveScanned)}this.updateSlavesOnlineInfo(null)}__hasForcedProcessData=!1;set hasForcedProcessData(value){this.__hasForcedProcessData=value}get hasForcedProcessData(){return this.__hasForcedProcessData}configDetailsValid(config){return config.targetNetId===this.__target.netId&&config.masterNetId===this.__netId}forcedProcessDataCbs=new Set;updateSlavesWithForcedProcessData(data){if(!this.configDetailsValid(data.config))return;const physAddrOfSlavesWithForcedProcessData=data.slaves;this.__hasForcedProcessData=physAddrOfSlavesWithForcedProcessData.length>0;for(const[physAddr,slave]of this.__slaves)slave.hasForcedProcessData=physAddrOfSlavesWithForcedProcessData.includes(physAddr);this.__extendedInfoOfSlave&&this.__extendedInfoOfSlave.updateDrawings();for(const cb of this.forcedProcessDataCbs)cb(physAddrOfSlavesWithForcedProcessData);this.network.drawMatrix()}updateSlavesOnlineInfo(data){if(void 0===data)return void TcHmi.Log.error("SlavesOnlineInfo returned 'undefined'.");if(null!==data&&!this.configDetailsValid(data.config))return;const symbol="GetSlavesOnlineInfo";let changes=null;if(this.__subscriptionOldReadValues.has(symbol)||this.__subscriptionOldReadValues.set(symbol,{}),null===data?changes=compareObjects({},this.__subscriptionOldReadValues.get(symbol)):(changes=compareObjects(this.__subscriptionOldReadValues.get(symbol),data),Object.assign(this.__subscriptionOldReadValues.get(symbol)??{},data)),null===changes)return;const changesSlaves=changes.slaves;if(changesSlaves)for(const[slavePhysAddr,slaveChanges]of Object.entries(changesSlaves)){const addr=parseInt(slavePhysAddr,10),slave=this.getSlave(addr);slave?null!==data&&void 0!==slaveChanges.current?.presence?.notPresent?slave.processOnlineChanges(data.slaves[slavePhysAddr]??null):slave.processOnlineChanges(slaveChanges):TcHmi.Log.error("Matching slave to process online info not found")}this.__extendedInfoOfSlave&&this.__extendedInfoOfSlave.updateDrawings(),this.network.drawMatrix()}findScannedSlaveByIdentity(vendor,product,revision,onlyIdentityInvalid){if(this.__slavesScanned&&this.__slavesScanned.slaves){let indexOfScannedSlave=null;for(const[i,slaveScanned]of this.__slavesScanned.slaves.entries())if(slaveScanned.vendorId===vendor&&slaveScanned.productCode===product&&slaveScanned.revisionNumber===revision&&(!onlyIdentityInvalid||0===slaveScanned.addr)){indexOfScannedSlave=i;break}if(null===indexOfScannedSlave)return null;let countToIndexOfScannedSlave=0;for(const configuredSlave of this.__slavesSorted)if(configuredSlave&&!configuredSlave.isDisabled&&configuredSlave.isPresent){if(countToIndexOfScannedSlave===indexOfScannedSlave)return configuredSlave;countToIndexOfScannedSlave++}}return null}findSlaveByIdentity(vendor,product,revision,onlyIdentityInvalidOrNotPresent){for(const slave of this.__slavesSorted){const identity=slave.data.EtherCAT.identity;if(vendor===identity.vendor.id.value&&product===identity.product.value&&revision===identity.revision.value&&(!onlyIdentityInvalidOrNotPresent||slave.hasInvalidIdentity||slave.isNotPresent))return slave}return null}findFirstNotPresentSlave(){for(const slave of this.__slavesSorted)if(slave.isNotPresent)return slave;return null}processOnlineChanges(changes){const onlineData=this.data.online;setOnlineData(onlineData.frames.total.cyclic,changes.frames?.total?.cyclic),setOnlineData(onlineData.frames.total.acyclic,changes.frames?.total?.acyclic),setOnlineData(onlineData.frames.missed.cyclic,changes.frames?.missed?.cyclic),setOnlineData(onlineData.frames.missed.acyclic,changes.frames?.missed?.acyclic),setOnlineData(onlineData.frames.perSec.cyclic,changes.frames?.perSec?.cyclic),setOnlineData(onlineData.frames.perSec.acyclic,changes.frames?.perSec?.acyclic),setOnlineData(onlineData.frames.damaged.sent,changes.frames?.damaged?.sent),setOnlineData(onlineData.frames.damaged.received,changes.frames?.damaged?.received),setOnlineData(onlineData.frames.damaged.sent,changes.frames?.damaged?.sent),setOnlineData(onlineData.frames.damaged.received,changes.frames?.damaged?.received),setOnlineData(onlineData.stateMachine.code,changes.stateMachine),changes.stateMachine&&setOnlineData(onlineData.stateMachine.name,StateMachineStateName[changes.stateMachine]),setOnlineData(onlineData.stateMachineRequested.code,changes.stateMachineRequested),changes.stateMachineRequested&&setOnlineData(onlineData.stateMachineRequested.name,StateMachineStateName[changes.stateMachineRequested])}}