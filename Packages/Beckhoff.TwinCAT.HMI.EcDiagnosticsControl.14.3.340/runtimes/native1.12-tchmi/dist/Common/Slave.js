import{Component,StateMachineStateName}from"./Component.js";import{SlaveTerminalGroup}from"./SlaveGroup.js";import{PortPhysic,PortSlave,PortStates,PortOrientation}from"./Port.js";import{setOnlineData}from"./DOMUtility.js";import{extensionName}from"./Defines.js";import{toHexString,baseConverter}from"./Utility.js";import{ExtendedInfoOfSlave}from"./ExtendedInfo.js";import{NotificationLevel}from"./Notifications.js";export class Slave extends Component{constructor(srSlaveData,trace,connection,slaveTerminalGroup,parentSubSlaves){super(trace.topology.master.numOfSlaves),this.__trace=trace,this.__slaveTerminalGroup=slaveTerminalGroup,this.__data={EtherCAT:{identity:{addrs:{autoInc:srSlaveData.EtherCAT.identity.addrs.autoInc,phys:srSlaveData.EtherCAT.identity.addrs.phys},name:{value:srSlaveData.EtherCAT.identity.name,domElements:new Set},type:{value:srSlaveData.EtherCAT.identity.type,domElements:new Set},vendor:{id:{value:srSlaveData.EtherCAT.identity.vendor.id,domElements:new Set},memberNameLong:{value:srSlaveData.EtherCAT.identity.vendor.memberNameLong,domElements:new Set},memberNameShort:{value:srSlaveData.EtherCAT.identity.vendor.memberNameShort,domElements:new Set}},product:{value:srSlaveData.EtherCAT.identity.product,domElements:new Set},revision:{value:srSlaveData.EtherCAT.identity.revision,domElements:new Set},serial:{value:srSlaveData.EtherCAT.identity.serial,domElements:new Set}},hotConnect:srSlaveData.hotConnect,syncUnitsAssignment:srSlaveData.EtherCAT.syncUnitsAssignment},online:{current:{stateMachine:{code:{value:null,domElements:new Set},name:{value:null,domElements:new Set}},presence:{notPresent:{value:!1,domElements:new Set},notPresentOnPrevSlaves:{value:!1,domElements:new Set}},disabled:{value:!1,domElements:new Set},initError:{value:!1,domElements:new Set},signalsError:{value:!1,domElements:new Set},identity:{isInvalid:{value:!1,domElements:new Set},isInvalidOnPrevSlaves:{value:!1,domElements:new Set}}},requested:{stateMachine:{code:{value:null,domElements:new Set},name:{value:null,domElements:new Set}}},counter:{crc:{sum:{value:null,domElements:new Set},highestWarningLevel:{value:null,domElements:new Set}},abnormalChanges:{value:null,domElements:new Set},connectionLosses:{value:null,domElements:new Set}},labels:[],messages:{value:null,domElements:new Set},syncUnits:new Map},processData:srSlaveData.processData,scannedIdentity:null},this.master.addSlave(this),this.master.addSortedSlave(this);const traceXOffset=trace.addSlave(this);this.__pos={slave:null,networkTraceXOffset:0,traceXOffset,trace:null,network:{x:-1,y:-1}},this.__calculateDesign();const portsData=[];let outgoingEbusPortOccupied=!1;for(const dataKey of Object.keys(srSlaveData.ports)){const data=srSlaveData.ports[dataKey];"0"===dataKey?connection?.outPort?.physic===PortPhysic.MII&&data.physic===PortPhysic.EBUS&&(data.physic=PortPhysic.MII):outgoingEbusPortOccupied?data.physic=PortPhysic.MII:data.physic===PortPhysic.EBUS&&(outgoingEbusPortOccupied=!0),portsData.push(data)}const subSlaves=[];this.__initPorts(portsData,connection,subSlaves),this.__subSlaves.push.apply(this.__subSlaves,subSlaves),parentSubSlaves.push.apply(parentSubSlaves,this.__subSlaves),parentSubSlaves.push(this)}static getShortSlaveType(type){return type.length>(type=(type.slice(0,4)+(type.slice(4).match(/[a-zA-Z0-9]+/)?.[0]??"")).slice(0,7)).length&&(type+=String.fromCharCode(8230)),type}__trace;get trace(){return this.__trace}get topology(){return this.trace.topology}get network(){return this.topology.network}get master(){return this.network.master}__subSlaves=[];get subSlaves(){return this.__subSlaves}get numOfSubSlaves(){return this.__subSlaves.length}__slaveTerminalGroup=null;get slaveTerminalGroup(){return this.__slaveTerminalGroup?.isSlaveGroup?this.__slaveTerminalGroup:null}__expansion=!0;get expansion(){return this.__expansion}set expansion(value){(value||0!==this.numOfSubSlaves)&&(this.__expansion=value)}toggleExpansion(){this.expansion=!this.__expansion}__specialTerminals(){const type=this.__data.EtherCAT.identity.type.value;"EL2904"===type?(this.__design.dimension={width:200,height:400},this.__design.color={r:227,g:179,b:33}):["EL6900","EL1904"].includes(type)?this.__design.color={r:227,g:179,b:33}:type.startsWith("AX")?this.__design.dimension={width:300,height:600}:"EL1012"===type&&(this.__design.dimension={width:100,height:400})}__initPorts(portsData,connection,subSlaves){const[inPortData,...outPortsData]=portsData;this.__numOfConfiguredPorts=0,this.__numOfCableLinkPorts=0,this.__numOfOutgoingConfiguredCableLinkPorts=0,inPortData.physic===PortPhysic.MII&&(this.__hasIncomingCableLinkPort=!0,this.__numOfCableLinkPorts++),inPortData.configured&&this.__numOfConfiguredPorts++;for(const portData of outPortsData)portData.physic===PortPhysic.EBUS?portData.configured&&(this.__hasOutgoingConfiguredEBusPort=!0):portData.physic===PortPhysic.MII&&(this.__numOfCableLinkPorts++,portData.configured&&this.__numOfOutgoingConfiguredCableLinkPorts++),portData.configured&&this.__numOfConfiguredPorts++;this.__numOfCableLinkPorts>0?this.__slaveTerminalGroup=null:null===this.__slaveTerminalGroup?this.__slaveTerminalGroup=new SlaveTerminalGroup(this):this.__slaveTerminalGroup.addSubSlave(this);let portIndex=0;const inPort=new PortSlave(this,portIndex++,inPortData,connection,null,[]);this.__ports.push(inPort);for(const portData of outPortsData){const port=new PortSlave(this,portIndex++,portData,null,this.__slaveTerminalGroup,subSlaves);this.__ports.push(port)}}__pos;set networkPos(value){this.__pos.network=value}get networkPos(){return this.__pos.network}get pos(){return this.__pos}get coordinates(){const traceCoordinates=this.trace.pos;return traceCoordinates?{col:traceCoordinates.col+this.__pos.networkTraceXOffset,row:traceCoordinates.row}:null}get syncUnitIds(){return this.__data.EtherCAT.syncUnitsAssignment}__data;get data(){return this.__data}get name(){return this.__data.EtherCAT.identity.name.value}get addr(){return this.__data.EtherCAT.identity.addrs.phys}get autoIncAddr(){return this.__data.EtherCAT.identity.addrs.autoInc}__processDataSubscription=null;readProcessDataValues(updateForcedState=!1){this.master.main.comObj?.writeSymbol(`${extensionName}.GetProcessDataValues`,{device:this.master.main.config.device,slaveAddr:this.addr,updateForcedState},data=>{this.__processProcessDataValues(data)})}hasProcessDataObjects(){const pdos=this.processData;return pdos&&(0!==pdos.input.length||0!==pdos.output.length)}__processDataValuesSubscriptionCounter=0;subscribeToProcessDataValues(){if(this.hasProcessDataObjects())if(this.__processDataValuesSubscriptionCounter<0)TcHmi.Log.error("Reference counter of process data value subscription < 0. A reference counter should never be a negative value.");else{if(0===this.__processDataValuesSubscriptionCounter){const comObj=this.master.main.comObj;if(!comObj)return void TcHmi.Log.error("WebSocket object is invalid.");this.__processDataSubscription=comObj.subscribe({symbol:`${extensionName}.GetProcessDataValues`,writeValue:{device:this.master.main.config.device,slaveAddr:this.addr}},100,data=>{this.__processProcessDataValues(data)},()=>{TcHmi.Log.info(`${extensionName}.GetProcessValues was subscribed on slaveAddr ${this.addr} successfully.`)})}this.__processDataValuesSubscriptionCounter++}}unsubscribeProcessValueSubscription(){this.hasProcessDataObjects()&&(this.__processDataValuesSubscriptionCounter--,this.__processDataValuesSubscriptionCounter<0?TcHmi.Log.error("Reference counter of process data value subscription < 0. A reference counter should never be a negative value."):0===this.__processDataValuesSubscriptionCounter&&(this.master.main.comObj?this.__processDataSubscription&&(this.master.main.comObj.unsubscribe(this.__processDataSubscription,()=>{this.__processDataValuesSubscriptionCounter>0||(this.__removeProcessDataValues(),TcHmi.Log.info("Unsubscribed successfully."))}),this.__processDataSubscription=null):TcHmi.Log.error("WebSocket object is invalid.")))}__removeProcessDataValues(){if(this.__data.processData)for(const io of[this.__data.processData.input,this.__data.processData.output])for(const object of io)for(const entry of object.entries)delete entry.historyValue,delete entry.preparedValue,delete entry.value,delete entry.historyChartUpdateInterval}__hasForcedProcessData=!1;set hasForcedProcessData(value){this.__hasForcedProcessData=value}get hasForcedProcessData(){return this.__hasForcedProcessData}couplerGroupHasForcedProcessData(){if(!this.__expansion)for(const slave of this.subSlaves)if(slave.hasForcedProcessData)return!0;return!1}setProcessDataValues(values,cbErrorEl){this.master.main.comObj?this.master.main.comObj.writeSymbol(`${extensionName}.SetProcessDataValues`,{device:this.master.main.config.device,slaveAddr:this.addr,values},()=>{this.readProcessDataValues(!0)},cbErrorEl):TcHmi.Log.error("WebSocket object is invalid.")}forceProcessDataValues(values,cbErrorEl){this.master.main.comObj?this.master.main.comObj.writeSymbol(`${extensionName}.ForceProcessDataValues`,{device:this.master.main.config.device,slaveAddr:this.addr,values},()=>{this.readProcessDataValues(!0)},cbErrorEl):TcHmi.Log.error("WebSocket object is invalid.")}releaseProcessDataValues(values,cbErrorEl){this.master.main.comObj?this.master.main.comObj.writeSymbol(`${extensionName}.ReleaseProcessDataValues`,{device:this.master.main.config.device,slaveAddr:this.addr,values},()=>{this.readProcessDataValues(!0)},cbErrorEl):TcHmi.Log.error("WebSocket object is invalid.")}getProcessDataObjects(io){if(this.processData)return this.processData[io]}getProcessDataObject(objects,index){for(const object of objects)if(object.index===index)return object;return null}getProcessDataObjectEntry(object,index,subIndex){for(const entry of object.entries)if(entry.index===index&&entry.subIndex===subIndex)return entry;return null}__processProcessDataValues(data){if(void 0!==data)for(const ioType of["input","output"]){const processDataValueObjects=data[ioType],processDataObjects=this.getProcessDataObjects(ioType);if(!processDataObjects)return void TcHmi.Log.error(`No process data objects of io type '${ioType}' found to insert new values.`);for(const valueObject of processDataValueObjects){const processDataObject=this.getProcessDataObject(processDataObjects,valueObject.index);if(!processDataObject)return void TcHmi.Log.error(`No process data objects of io type '${ioType}' and object index '${valueObject.index}' found to insert new values.`);let atLeastOneEntryForced=!1;for(const entry of valueObject.entries){const processDataObjectEntry=this.getProcessDataObjectEntry(processDataObject,entry.index,entry.subIndex);if(!processDataObjectEntry)return void TcHmi.Log.error(`No process data object entry of io type '${ioType}', object index '${valueObject.index}', entry index '${entry.index}' and entry subIndex '${entry.subIndex}' found to insert new values.`);if(atLeastOneEntryForced||=entry.forced,entry.error&&processDataObjectEntry.value?.errorElements){const errorContent=entry.error.reason??entry.error.message??entry.error.code?.toString()??"";for(const errorEl of processDataObjectEntry.value.errorElements)errorEl.innerHTML!==errorContent&&(errorEl.innerHTML=errorContent);continue}const value=entry.value;processDataObjectEntry.historyValue||(processDataObjectEntry.historyValue=[]),processDataObjectEntry.historyChartsVisible?.size||(processDataObjectEntry.historyValue=[]);let convertedValue=value;"boolean"==typeof convertedValue&&(convertedValue=convertedValue?1:0),processDataObjectEntry.historyValue.push({ts:Date.now(),value:convertedValue,forced:entry.forced});const maxHistoryTime=30,tsNow=Date.now();for(;processDataObjectEntry.historyValue.length>1&&processDataObjectEntry.historyValue[1].ts+1e3*maxHistoryTime<tsNow;)processDataObjectEntry.historyValue.shift();if(!this.setProcessDataValue(processDataObjectEntry,value,entry.forced))return void TcHmi.Log.warn("no element found to apply process data value")}if(processDataObject.atLeastOneEntryForced=atLeastOneEntryForced,processDataObject.atLeastOneEntryForcedDomElements&&processDataObject.atLeastOneEntryForcedDomElements.size>0)for(const el of processDataObject.atLeastOneEntryForcedDomElements)el.isConnected?el.classList.toggle("hide",!processDataObject.atLeastOneEntryForced):processDataObject.atLeastOneEntryForcedDomElements.delete(el)}}else TcHmi.Log.warn(`Process data value of '${this.addr}' returned as undefined. Check other errors of symbol '${extensionName}.GetProcessDataValues'.`)}__processDataValues=new Map;getProcessDataValues(pdoType,objectIndex,entryIndex,entrySubIndex){return this.__processDataValues.get(pdoType)?.get(objectIndex)?.get(entryIndex)?.get(entrySubIndex)?.value}setProcessDataValue(entry,value,forced){return null==value?(TcHmi.Log.error("Process data value is invalid."),!1):(entry.value?(entry.value.forced=forced,entry.value.value=value):entry.value={value,domElements:new Set,forced,forcedDomElements:new Set,errorElements:new Set},this.updateProcessDataValuesOnlineElements(entry))}updateProcessDataValuesOnlineElements(entry){const onlineEntryValue=entry.value;if(!onlineEntryValue)return!1;const elements=onlineEntryValue.domElements;if(!elements||0===elements.size)return!1;const valueString=onlineEntryValue.value?.toString(),valueStateForcedString=onlineEntryValue.forced?"true":"false";if(!valueString)return!1;for(const el of elements)if(el.dataset.value!==valueString||el.dataset.valueStateForced!==valueStateForcedString||"true"===el.dataset.showValueAsHex!=(!0===entry.showValueAsHex)){if(el.classList.remove("no-value"),el.innerHTML="",el.dataset.valueOnly)entry.showValueAsHex&&"number"==typeof onlineEntryValue.value?(el.insertAdjacentHTML("beforeend",toHexString(onlineEntryValue.value)),el.dataset.showValueAsHex="true"):(el.insertAdjacentText("beforeend",valueString),delete el.dataset.showValueAsHex);else{for(const el of onlineEntryValue.forcedDomElements)el.isConnected||onlineEntryValue.forcedDomElements.delete(el),el.classList.toggle("hide",!onlineEntryValue.forced);"boolean"==typeof onlineEntryValue.value?el.innerHTML=`<span class="boolean-representation ${valueString}">${valueString}</span>`:entry.showValueAsHex&&"number"==typeof onlineEntryValue.value?(el.insertAdjacentHTML("beforeend",toHexString(onlineEntryValue.value)),el.dataset.showValueAsHex="true"):(el.insertAdjacentHTML("beforeend",onlineEntryValue.value),delete el.dataset.showValueAsHex),el.classList.add("change-highlight"),el.dataset.highlightTimeout&&clearTimeout(parseInt(el.dataset.highlightTimeout,10)),el.dataset.highlightTimeout=setTimeout(()=>{el.classList.remove("change-highlight"),el.removeAttribute("data-highlight-timeout")},1e3).toString()}el.dataset.value=valueString,el.dataset.valueStateForced=valueStateForcedString}return!0}addProcessDataValueElement(entry,el){entry.domElements||(entry.domElements=new Set),entry.domElements.add(el)}__errorMessages=new Set;get onlineData(){return this.__data.online}get processData(){return this.__data.processData}getStateMachineState(hexString){return baseConverter(hexString[3],16,10)}processScannedIdentity(scannedIdentity){this.__data.scannedIdentity=scannedIdentity}processOnlineChanges(changes){if(!changes)return;const online=this.__data.online,localization=this.master.target.main.getLocalization();if(changes.current){const statemachine_state_current=changes.current.stateMachine;statemachine_state_current&&(setOnlineData(online.current.stateMachine.code,statemachine_state_current),setOnlineData(online.current.stateMachine.name,StateMachineStateName[statemachine_state_current])),setOnlineData(online.current.identity.isInvalid,changes.current.identity?.isInvalid),setOnlineData(online.current.identity.isInvalidOnPrevSlaves,changes.current.identity?.isInvalidOnPrevSlaves),changes.current.presence&&(setOnlineData(online.current.presence.notPresent,changes.current.presence.notPresent),setOnlineData(online.current.presence.notPresentOnPrevSlaves,changes.current.presence.notPresentOnPrevSlaves)),setOnlineData(online.current.disabled,changes.current.disabled),setOnlineData(online.current.initError,changes.current.initError),setOnlineData(online.current.signalsError,changes.current.signalsError)}if(changes.requested){const statemachine_state_requested=changes.requested.stateMachine;statemachine_state_requested&&(setOnlineData(online.requested.stateMachine.code,statemachine_state_requested),setOnlineData(online.requested.stateMachine.name,StateMachineStateName[statemachine_state_requested]))}changes.counter&&(this.isPresent&&!this.isDisabled?(setOnlineData(online.counter.connectionLosses,changes.counter.connectionLosses),setOnlineData(online.counter.abnormalChanges,changes.counter.abnormalChanges)):(setOnlineData(online.counter.connectionLosses,null),setOnlineData(online.counter.abnormalChanges,null)));const portsChanges=changes.ports;if(portsChanges)for(const[portIndex,portChanges]of portsChanges.entries()){if(!portChanges)continue;const port=this.getPortByIndex(portIndex);if(!port)continue;const portOnline=port.online;setOnlineData(portOnline.current.unexpectedLink,portChanges.current?.unexpectedLink),setOnlineData(portOnline.current.missingLink,portChanges.current?.missingLink),setOnlineData(portOnline.current.linkError,portChanges.current?.linkError),this.isPresent&&!this.isDisabled&&port.configured?(setOnlineData(portOnline.counter.crc.total,portChanges.counter?.crc?.total),setOnlineData(portOnline.counter.crc.errorOnPrevPort,portChanges.counter?.crc?.errorOnPrevPort)):setOnlineData(portOnline.counter.crc.total,null)}if(this.__clearErrorMessages(),this.isNotPresent){const slaveNotPresentWrapper=document.createElement("div");this.__addErrorElement(slaveNotPresentWrapper),slaveNotPresentWrapper.classList.add("slave-message");const slaveNotPresentLabel=document.createElement("span");if(slaveNotPresentLabel.classList.add("bold"),localization.addElement(slaveNotPresentLabel,"Msg_Slave_Not_Present"),slaveNotPresentWrapper.append(slaveNotPresentLabel),this.hasNotPresentSlavesBefore){slaveNotPresentWrapper.classList.add("slave-message-warning");const consequentialErrorLabel=document.createElement("div");slaveNotPresentWrapper.append(consequentialErrorLabel),localization.addElement(consequentialErrorLabel,"Msg_Slave_Consequential_Error");const consequentialErrorListEl=document.createElement("ul");slaveNotPresentWrapper.append(consequentialErrorListEl);const consequentialErrorListNotPresentWrapper=document.createElement("li");consequentialErrorListEl.append(consequentialErrorListNotPresentWrapper);const consequentialErrorListNotPresentLabel=document.createElement("span");localization.addElement(consequentialErrorListNotPresentLabel,"Msg_Slave_Consequential_Error_Previous_Slaves_Not_Present");const btnGoToPrevNotPresentSlave=document.createElement("div");btnGoToPrevNotPresentSlave.classList.add("navigation-link"),consequentialErrorListNotPresentWrapper.append(consequentialErrorListNotPresentLabel,btnGoToPrevNotPresentSlave),localization.addElement(btnGoToPrevNotPresentSlave,"Msg_Slave_Consequential_Error_Previous_Slaves_Not_Present_Go_To_Previous_Slave_Btn"),btnGoToPrevNotPresentSlave.addEventListener("click",()=>{const firstNotPresentSlave=this.master.findFirstNotPresentSlave();firstNotPresentSlave&&this.master.setExtendedInfoOfSlave(new ExtendedInfoOfSlave(firstNotPresentSlave))})}else{slaveNotPresentWrapper.classList.add("slave-message-error");const firstOccurrenceLabel=document.createElement("span");firstOccurrenceLabel.classList.add("round-brackets"),localization.addElement(firstOccurrenceLabel,"Msg_First_Occurence"),slaveNotPresentWrapper.append(firstOccurrenceLabel)}}if(this.isDisabled){const slaveDisabledWrapper=document.createElement("div");this.__addErrorElement(slaveDisabledWrapper),slaveDisabledWrapper.classList.add("slave-message-warning"),localization.addElement(slaveDisabledWrapper,"Msg_Slave_Disabled")}const identityError=document.createElement("div");if(identityError.classList.add("slave-message"),this.onlineData.current.identity.isInvalid.value){const msgIdentityError=document.createElement("div");msgIdentityError.classList.add("bold"),localization.addElement(msgIdentityError,"Msg_Slave_Identity_Error");const msgIdentityErrorDesc=document.createElement("div");if(localization.addElement(msgIdentityErrorDesc,"Msg_Slave_Identity_Error_Desc"),identityError.append(msgIdentityError,msgIdentityErrorDesc),this.hasInvalidIdentityBefore||this.hasNotPresentSlavesBefore){identityError.classList.add("slave-message-warning");const msgSlaveConsequentialError=document.createElement("div");localization.addElement(msgSlaveConsequentialError,"Msg_Slave_Consequential_Error");const msgSlaveConsquentialErrorReasons=document.createElement("ul");if(this.hasInvalidIdentityBefore){const msgSlaveConsequentialErrorReason=document.createElement("li");msgSlaveConsquentialErrorReasons.append(msgSlaveConsequentialErrorReason),localization.addElement(msgSlaveConsequentialErrorReason,"Msg_Slave_Consequential_Error_Previous_Slaves_Invalid_Identity")}if(this.hasNotPresentSlavesBefore){const msgSlaveConsequentialErrorReason=document.createElement("li");msgSlaveConsquentialErrorReasons.append(msgSlaveConsequentialErrorReason),localization.addElement(msgSlaveConsequentialErrorReason,"Msg_Slave_Consequential_Error_Previous_Slaves_Not_Present")}identityError.append(msgSlaveConsequentialError,msgSlaveConsquentialErrorReasons)}else identityError.classList.add("slave-message-error");this.__addErrorElement(identityError)}let crc_sum=0,crcHighestWarningLevel=0;online.labels=[];for(const port of this.__ports){port.clearMessages();const portOnline=port.online;let portState=0;(online.current.stateMachine.code.value!==StateMachineStateName.Operational||this.isNotPresent)&&(portState=PortStates.notPresent),portOnline.current.unexpectedLink.value?(portState=PortStates.error,portOnline.current.linkError.value?port.addMessage(localization,["Msg_Port_Unexpected_Connection_Or_Connection_Error"],NotificationLevel.error):port.addMessage(localization,["Msg_Port_Unexpected_Connection"],NotificationLevel.error)):portOnline.current.missingLink.value?(portState=PortStates.error,portOnline.current.linkError.value?port.addMessage(localization,["Msg_Port_Connection_Missing_Or_Connection_Error"],NotificationLevel.error):port.addMessage(localization,["Msg_Port_Connection_Missing"],NotificationLevel.error)):portOnline.current.linkError.value&&(portState=PortStates.error,port.addMessage(localization,["Msg_Port_Connection_Error"],NotificationLevel.error)),port.state=portState;const crcValue=portOnline.counter.crc.total.value;crcValue&&crcValue>0&&(crc_sum+=crcValue,portOnline.counter.crc.errorOnPrevPort.value?(port.addMessage(localization,["Msg_Port_Crc_Error","Msg_Port_Consquential_Error"],NotificationLevel.warning),crcHighestWarningLevel=Math.max(crcHighestWarningLevel,NotificationLevel.warning)):(port.addMessage(localization,["Msg_Port_Crc_Error"],NotificationLevel.error),crcHighestWarningLevel=NotificationLevel.error)),port.updateMessages()}if(setOnlineData(online.counter.crc.sum,crc_sum),setOnlineData(online.counter.crc.highestWarningLevel,crcHighestWarningLevel),crc_sum>0&&online.labels.push({text:crc_sum.toString(),warningLevel:crcHighestWarningLevel}),this.onlineData.current.identity.isInvalid.value||(online.current.signalsError.value&&!online.current.initError.value?online.labels.push({text:"Statemachine",warningLevel:2}):online.current.initError.value&&!online.current.signalsError.value?online.labels.push({text:"Timeout",warningLevel:2}):online.current.initError.value&&online.current.signalsError.value&&online.labels.push({text:"Statemachine",warningLevel:2})),changes.syncUnits)for(const syncUnitChangeIdStr in changes.syncUnits){const syncUnitChange=changes.syncUnits[syncUnitChangeIdStr],syncUnitChangeId=parseInt(syncUnitChangeIdStr,10);if(!syncUnitChange)continue;let syncUnit=online.syncUnits.get(syncUnitChangeId);syncUnit||(syncUnit={error:{value:!1,domElements:new Set},faultCounter:{value:0,domElements:new Set},framesMissedCount:{value:0,domElements:new Set}},online.syncUnits.set(syncUnitChangeId,syncUnit)),setOnlineData(syncUnit.faultCounter,syncUnitChange.wcFaultCounter),setOnlineData(syncUnit.framesMissedCount,syncUnitChange.frameMissedCounter),setOnlineData(syncUnit.error,syncUnitChange.error)}const comObj=this.master.main.comObj;if(comObj){if(null!==this.__data.scannedIdentity){if(this.main.getSymbolAccess(`${extensionName}.SendSlavesScanCmd`)){const scanNetworkBtn=document.createElement("button");if(scanNetworkBtn.classList.add("regular-button"),this.master.isSlavesScanInProgress)localization.addElement(scanNetworkBtn,"Slave_Scan_In_Progress");else{const rescanLabel=document.createElement("div");if(localization.addElement(rescanLabel,"Slave_Scan_Rescan"),scanNetworkBtn.append(rescanLabel),this.master.slavesScanned){const lastUpdate=document.createElement("div");lastUpdate.classList.add("italic"),localization.addElement(lastUpdate,"Slave_Scan_Rescan_Last_Update",[this.master.slavesScanned.updated]),scanNetworkBtn.append(lastUpdate)}}scanNetworkBtn.classList.add("slave-message-btn"),scanNetworkBtn.classList.add("slave-message-btn-center"),scanNetworkBtn.addEventListener("click",()=>{const masterWriteValue=this.main.config.device;comObj.writeSymbol(`${extensionName}.SendSlavesScanCmd`,masterWriteValue,()=>{localization.addElement(scanNetworkBtn,"Slave_Scan_In_Progress"),this.master.slavesScanInProgress=!0,TcHmi.Log.info("Rescan cmd sent successfully.")})}),identityError.append(scanNetworkBtn)}const scannedIdentity=this.__data.scannedIdentity;this.setScannedIdentityCheck(scannedIdentity.vendorId,this.__data.EtherCAT.identity.vendor),this.setScannedIdentityCheck(scannedIdentity.productCode,this.__data.EtherCAT.identity.product),this.setScannedIdentityCheck(scannedIdentity.revisionNumber,this.__data.EtherCAT.identity.revision),this.setScannedIdentityCheck(scannedIdentity.serialNumber,this.__data.EtherCAT.identity.serial),this.setScannedIdentityCheck(this.__data.scannedIdentity.vendorMemberName,this.__data.EtherCAT.identity.vendor.memberNameLong);const vprs={vendor:this.data.EtherCAT.identity.vendor.id.value,product:this.data.EtherCAT.identity.product.value,revision:this.data.EtherCAT.identity.revision.value,serial:this.data.EtherCAT.identity.serial.value};if(this.__data.online.current.identity.isInvalid.value){const configuredIdentityFoundAtSlave=this.master.findScannedSlaveByIdentity(vprs.vendor,vprs.product,vprs.revision,!0),scannedIdentityFoundAtSlave=this.master.findSlaveByIdentity(scannedIdentity.vendorId,scannedIdentity.productCode,scannedIdentity.revisionNumber,!0);if(configuredIdentityFoundAtSlave||scannedIdentityFoundAtSlave){scannedIdentityFoundAtSlave&&(this.setScannedIdentityCheck(scannedIdentityFoundAtSlave.data.EtherCAT.identity.vendor.memberNameLong.value,this.__data.EtherCAT.identity.vendor.memberNameLong),this.setScannedIdentityCheck(scannedIdentityFoundAtSlave.data.EtherCAT.identity.type.value,this.__data.EtherCAT.identity.type),this.setScannedIdentityCheck(scannedIdentityFoundAtSlave.data.EtherCAT.identity.name.value,this.__data.EtherCAT.identity.name));const swappedSlave=configuredIdentityFoundAtSlave===scannedIdentityFoundAtSlave?configuredIdentityFoundAtSlave:null;if(swappedSlave){const msgSwappedSlave=document.createElement("span"),btnSwappedSlave=document.createElement("span");btnSwappedSlave.classList.add("navigation-link"),btnSwappedSlave.textContent=swappedSlave.name,btnSwappedSlave.addEventListener("click",()=>{this.master.setExtendedInfoOfSlave(new ExtendedInfoOfSlave(swappedSlave))}),localization.addElement(msgSwappedSlave,"Slave_Scan_VPRS_Error_Swapped_Identity",[btnSwappedSlave]),identityError.append(msgSwappedSlave)}else{if(scannedIdentityFoundAtSlave){const msg=document.createElement("span"),btnScannedIdentityFoundAtSlave=document.createElement("span");btnScannedIdentityFoundAtSlave.classList.add("navigation-link"),btnScannedIdentityFoundAtSlave.textContent=scannedIdentityFoundAtSlave.name,btnScannedIdentityFoundAtSlave.addEventListener("click",()=>{this.master.setExtendedInfoOfSlave(new ExtendedInfoOfSlave(scannedIdentityFoundAtSlave))}),localization.addElement(msg,"Slave_Scan_VPRS_Error_Scanned_Identity_Found_In_Configured_Network",[btnScannedIdentityFoundAtSlave]),identityError.append(msg)}else{const msg=document.createElement("span");localization.addElement(msg,"Slave_Scan_VPRS_Error_Scanned_Identity_Missing_In_Configured_Network"),identityError.append(msg)}if(configuredIdentityFoundAtSlave){const msg=document.createElement("span"),btnConfiguredIdentityFoundAtSlave=document.createElement("span");btnConfiguredIdentityFoundAtSlave.classList.add("navigation-link"),btnConfiguredIdentityFoundAtSlave.textContent=configuredIdentityFoundAtSlave.name,btnConfiguredIdentityFoundAtSlave.addEventListener("click",()=>{this.master.setExtendedInfoOfSlave(new ExtendedInfoOfSlave(configuredIdentityFoundAtSlave))}),localization.addElement(msg,"Slave_Scan_VPRS_Error_Configured_Identity_Found_In_Scanned_Network",[btnConfiguredIdentityFoundAtSlave]),identityError.append(msg)}else{const msg=document.createElement("span");localization.addElement(msg,"Slave_Scan_VPRS_Error_Configured_Identity_Missing_In_Scanned_Network"),identityError.append(msg)}}}else{const msg=document.createElement("span");localization.addElement(msg,"Slave_Scan_VPRS_Error_Identities_Not_In_Network"),identityError.append(msg)}}}else if(this.main.getSymbolAccess(`${extensionName}.SendSlavesScanCmd`)){const scanNetworkBtn=document.createElement("button");localization.addElement(scanNetworkBtn,"Slave_Scan_Button"),scanNetworkBtn.classList.add("regular-button"),scanNetworkBtn.classList.add("slave-message-btn"),scanNetworkBtn.classList.add("slave-message-btn-center"),scanNetworkBtn.addEventListener("click",()=>{const comObj=this.master.main.comObj,masterWriteValue=this.main.config.device;comObj&&comObj.writeSymbol(`${extensionName}.SendSlavesScanCmd`,masterWriteValue,()=>{TcHmi.Log.info("Scan slaves command sent successfully.")})}),identityError.append(scanNetworkBtn)}if(online.messages.domElements)for(const msgEl of online.messages.domElements){let contentChanged=!0;if(msgEl.childElementCount===this.__errorMessages.size){contentChanged=!1;let msgSubEl=msgEl.firstElementChild;for(const errEl of this.__errorMessages){if(msgSubEl?.innerHTML!==errEl.innerHTML){contentChanged=!0;break}msgSubEl=msgSubEl?.nextElementSibling}}if(contentChanged){msgEl.innerHTML="";for(const errEl of this.__errorMessages)msgEl.append(errEl)}}}}setScannedIdentityCheck(valueScanned,target){if(target.domElements){let value=target.value;""!==valueScanned&&target.value!==valueScanned&&(value=`<span class="crossed-out">${target.value}</span> ${valueScanned}`);for(const domElement of target.domElements)if(domElement.innerHTML!==value){let targetValue=value;null===targetValue?(domElement.classList.add("no-value"),targetValue="-"):domElement.classList.remove("no-value"),domElement.innerHTML=targetValue}}}__addErrorElement(el){this.__errorMessages.add(el)}__clearErrorMessages(){this.__errorMessages.clear()}get isPresent(){return!this.isNotPresent}get isNotPresent(){return this.__data.online.current.presence.notPresent.value}get isDisabled(){return this.__data.online.current.disabled.value}get hasNotPresentSlavesBefore(){return this.__data.online.current.presence.notPresentOnPrevSlaves.value}get hasInvalidIdentity(){return this.__data.online.current.identity.isInvalid.value}get hasInvalidIdentityBefore(){return this.__data.online.current.identity.isInvalidOnPrevSlaves.value}get crcSum(){return this.__data.online.counter.crc.sum.value}get crcHighestWarningLevel(){return this.__data.online.counter.crc.highestWarningLevel.value}__design={dimension:{width:100,height:400},color:{r:249,g:249,b:249},labelHeight:100,labelColor:"#000",interior:{offset:{x:0,y:0},dimension:{width:0,height:0},section:{cols:1,rows:4}}};__calculateDesign(){this.__design.interior.dimension={width:this.__design.dimension.width,height:this.__design.dimension.height-this.__design.labelHeight}}__ports=[];get ports(){return this.__ports}__electricalCurrent=null;__dependentSlaves=null;get dependentSlaves(){return this.__dependentSlaves}set dependentSlaves(slaves){this.__dependentSlaves=slaves}__remainingCurrent=null;set remainingCurrent(remainingCurrent){this.__remainingCurrent=remainingCurrent}get remainingCurrent(){return this.__remainingCurrent}get electricalCurrent(){return this.__electricalCurrent}set electricalCurrent(electricalCurrent){this.__electricalCurrent=electricalCurrent}get identity(){return this.__data.EtherCAT.identity}getPortByIndex(index){return this.__ports[index]}getPortPhysByIndex(index){return this.__ports[index].physic}get staticInfo(){return this.__data.EtherCAT}__visibility=!1;get visibility(){return this.__visibility}set visibility(value){this.__visibility=value}set startCoordinates(coordinates){this.__trace.pos=coordinates}follow(xOffset){if(this.visibility=!0,this.__expansion||this.network.setToNotExpand(),this.__slaveTerminalGroup&&this.__slaveTerminalGroup.grouped)this.__slaveTerminalGroup.follow(xOffset);else if(this.topology.componentOrder.push(this),this.__trace.height=this.__design.dimension.height,this.__pos.networkTraceXOffset=xOffset,xOffset+=this.__design.dimension.width,this.__trace.addWidth(xOffset),this.__expansion)this.followPorts(xOffset);else for(const subSlave of this.__subSlaves)subSlave.visibility=!1}followPorts(xOffset){const coordinates=this.__trace.pos;if(!coordinates)return;const[,...outPorts]=this.__ports;for(const port of outPorts){let newCol=coordinates.col+xOffset,newRow=coordinates.row;const nextTrace=port.nextTrace;if(!nextTrace)continue;switch(port.isCableLink&&(newCol+=200),port.orientation){case PortOrientation.right:break;case PortOrientation.up:newRow=this.topology.addRow(newRow.index,{width:newCol,height:0});break;case PortOrientation.down:newRow=this.topology.addRow(newRow.index+1,{width:newCol,height:0});break;default:TcHmi.Log.error(`Invalid output-port orientation '${port.orientation}'. Outgoing ports should be orientated to right, up or down. But never to the left (reserved for incoming ports).`)}const newCoordinates={col:newCol,row:newRow};nextTrace.pos=newCoordinates}for(const port of outPorts){if(!port.configured)continue;let nextXOffset=0;port.isEBus&&(nextXOffset=xOffset),port.nextSlave?.follow(nextXOffset)}}}